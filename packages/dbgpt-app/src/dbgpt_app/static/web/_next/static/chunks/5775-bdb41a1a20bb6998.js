"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5775],{23430:function(e,t,l){var a=l(85893),r=l(25675),s=l.n(r);t.Z=function(e){let{src:t,label:l,width:r,height:n,className:i}=e;return(0,a.jsx)(s(),{className:"w-11 h-11 rounded-full mr-4 border border-gray-200 object-contain bg-white ".concat(i),width:r||44,height:n||44,src:t,alt:l||"db-icon"})}},43446:function(e,t,l){var a=l(41468),r=l(64371),s=l(62418),n=l(25519),i=l(1375),c=l(45360),o=l(67294);t.Z=e=>{let{queryAgentURL:t="/api/v1/chat/completions",app_code:l}=e,[d,u]=(0,o.useState)({}),{scene:x}=(0,o.useContext)(a.p),m=(0,o.useCallback)(async e=>{let{data:a,chatId:o,onMessage:d,onClose:m,onDone:h,onError:f,ctrl:p}=e;if(p&&u(p),!(null==a?void 0:a.user_input)&&!(null==a?void 0:a.doc_id)){c.ZP.warning(r.Z.t("no_context_tip"));return}let g={conv_uid:o,app_code:l};a&&Object.keys(a).forEach(e=>{g[e]=a[e]});try{var b;await (0,i.L)("".concat((0,s.bR)()).concat(t),{method:"POST",headers:{"Content-Type":"application/json",[n.gp]:null!==(b=(0,s.n5)())&&void 0!==b?b:""},body:JSON.stringify(g),signal:p?p.signal:null,openWhenHidden:!0,async onopen(e){e.ok&&e.headers.get("content-type")===i.a||"application/json"!==e.headers.get("content-type")||e.json().then(e=>{null==d||d(e),null==h||h(),p&&p.abort()})},onclose(){p&&p.abort(),null==m||m()},onerror(e){throw Error(e)},onmessage:e=>{let t=e.data;try{if("chat_agent"===x)t=JSON.parse(t).vis;else{var l,r,s;a=JSON.parse(e.data),t=null===(l=a.choices)||void 0===l?void 0:null===(r=l[0])||void 0===r?void 0:null===(s=r.message)||void 0===s?void 0:s.content}}catch(e){t.replaceAll("\\n","\n")}"string"==typeof t?"[DONE]"===t?null==h||h():(null==t?void 0:t.startsWith("[ERROR]"))?null==f||f(null==t?void 0:t.replace("[ERROR]","")):null==d||d(t):(null==d||d(t),null==h||h())}})}catch(e){p&&p.abort(),null==f||f("Sorry, We meet some error, please try agin later.",e)}},[t,l,x]);return{chat:m,ctrl:d}}},48218:function(e,t,l){var a=l(85893),r=l(82353),s=l(16165),n=l(67294);t.Z=e=>{let{width:t,height:l,scene:i}=e,c=(0,n.useCallback)(()=>{switch(i){case"chat_knowledge":return r.je;case"chat_with_db_execute":return r.zM;case"chat_excel":return r.DL;case"chat_with_db_qa":case"chat_dba":return r.RD;case"chat_dashboard":return r.In;case"chat_agent":return r.si;case"chat_normal":return r.O7;default:return}},[i]);return(0,a.jsx)(s.Z,{className:"w-".concat(t||7," h-").concat(l||7),component:c()})}},65775:function(e,t,l){l.r(t),l.d(t,{ChatContentContext:function(){return eZ},default:function(){return eE}});var a=l(85893),r=l(41468),s=l(80169),n=l(67294),i=l(68795),c=l(26024),o=l(15611),d=l(97937),u=l(74330),x=l(83062),m=l(55241),h=l(25278),f=l(14726),p=l(66309),g=l(92398),b=l(74309),v=l(67421);function _(e){return"tables"in e&&Array.isArray(e.tables)}var j=e=>{var t;let{previewData:l,onDelete:r}=e,{t:s}=(0,v.$G)(),[j,y]=(0,n.useState)({}),[N,w]=(0,n.useState)({}),[k,S]=(0,n.useState)({}),[C,Z]=(0,n.useState)("0"),E=(0,n.useRef)(null),T=l&&_(l),M=(0,n.useMemo)(()=>{if(l){if(_(l)){let e=parseInt(C,10);return l.tables[e]}return l}},[l,C]),R=e=>{if(null==e||""===e)return"-";let t=Number(e);return isNaN(t)?String(e):t.toLocaleString("zh-CN",{maximumFractionDigits:2})},O=(0,n.useMemo)(()=>(null==M?void 0:M.rows)?M.rows.filter(e=>Object.entries(j).every(t=>{let[l,a]=t;if(!a)return!0;let r=e[l];return String(null!=r?r:"").toLowerCase().includes(a.toLowerCase())})):[],[null==M?void 0:M.rows,j]),L=(0,n.useMemo)(()=>Object.values(j).filter(e=>e&&e.trim()).length,[j]);if(!l||!M||!M.columns||0===M.columns.length)return(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full gap-4 bg-[#ffffff80] dark:bg-[#ffffff29]",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-blue-500/20 blur-xl rounded-full"}),(0,a.jsx)(u.Z,{size:"large"})]}),(0,a.jsx)("span",{className:"text-slate-500 dark:text-slate-400 text-sm tracking-wide",children:s("loading_data")})]});let P=e=>{var t;let l=e.headerName.length,a=Math.max(...O.slice(0,100).map(l=>String(null!==(t=l[e.field])&&void 0!==t?t:"").length),l);return Math.max(120,Math.min(Math.max(14*l,10*a)+60,350))},z=e=>{let t=e.toLowerCase();return t.includes("int")||t.includes("float")||t.includes("double")||t.includes("number")?{bg:"bg-emerald-50 dark:bg-emerald-900/30",text:"text-emerald-600 dark:text-emerald-400"}:t.includes("date")||t.includes("time")?{bg:"bg-amber-50 dark:bg-amber-900/30",text:"text-amber-600 dark:text-amber-400"}:{bg:"bg-blue-50 dark:bg-blue-900/30",text:"text-blue-600 dark:text-blue-400"}},D=M.columns.map(e=>{let t=e.type.toLowerCase().includes("int")||e.type.toLowerCase().includes("float")||e.type.toLowerCase().includes("double"),l=!!j[e.field],r=P(e),n=z(e.type),o={title:(0,a.jsxs)("div",{className:"flex flex-col gap-0.5 py-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)(x.Z,{title:e.headerName,placement:"topLeft",children:(0,a.jsx)("span",{className:"font-semibold text-slate-700 dark:text-slate-200 truncate text-[13px] tracking-tight",children:e.headerName})}),(0,a.jsx)(m.Z,{open:k[e.field],onOpenChange:t=>{S(l=>({...l,[e.field]:t})),t&&setTimeout(()=>{var e;return null===(e=E.current)||void 0===e?void 0:e.focus()},100)},trigger:"click",placement:"bottomRight",content:(0,a.jsxs)("div",{className:"flex flex-col gap-3 p-1",style:{width:180},children:[(0,a.jsx)(h.default,{ref:E,size:"middle",placeholder:s("filter_placeholder"),value:j[e.field]||"",onChange:t=>y(l=>({...l,[e.field]:t.target.value})),onPressEnter:()=>S(t=>({...t,[e.field]:!1})),allowClear:!0,prefix:(0,a.jsx)(i.Z,{className:"text-slate-400"}),className:"rounded-lg"}),(0,a.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,a.jsx)(f.ZP,{size:"small",onClick:()=>{y(t=>({...t,[e.field]:""})),S(t=>({...t,[e.field]:!1}))},className:"rounded-md",children:s("reset")}),(0,a.jsx)(f.ZP,{type:"primary",size:"small",onClick:()=>S(t=>({...t,[e.field]:!1})),className:"rounded-md",children:s("confirm")})]})]}),children:(0,a.jsx)("div",{className:"\n                  w-5 h-5 rounded flex items-center justify-center cursor-pointer transition-all duration-200\n                  ".concat(l?"bg-blue-500 text-white shadow-sm":"hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-blue-500","\n                "),onClick:e=>e.stopPropagation(),children:(0,a.jsx)(c.Z,{className:"text-[10px]"})})})]}),(0,a.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded w-fit ".concat(n.bg," ").concat(n.text),children:e.type})]}),dataIndex:e.field,key:e.field,width:r,ellipsis:{showTitle:!0},align:t?"right":"left",render:e=>null==e||""===e?(0,a.jsx)("span",{className:"text-slate-300 dark:text-slate-600",children:"-"}):t?(0,a.jsx)("span",{className:"font-mono text-[13px] text-slate-700 dark:text-slate-300 tabular-nums",children:R(e)}):(0,a.jsx)("span",{className:"text-[13px] text-slate-600 dark:text-slate-400",children:e}),sorter:(l,a)=>{let r=l[e.field],s=a[e.field];return t?(Number(r)||0)-(Number(s)||0):String(null!=r?r:"").localeCompare(String(null!=s?s:""))},sortOrder:N.columnKey===e.field?N.order:null,onHeaderCell:()=>({style:{minWidth:r,maxWidth:r}}),onCell:()=>({style:{minWidth:r,maxWidth:r}})};return o}),I=T?l.file_name||(null==M?void 0:M.file_name)||"":(null==M?void 0:M.file_name)||"",V=(null==M?void 0:M.total)||0,A=(null==M?void 0:null===(t=M.columns)||void 0===t?void 0:t.length)||0,F=T?l.tables:null;return(0,a.jsxs)("div",{className:"h-full flex flex-col bg-[#ffffff80] dark:bg-[#ffffff29]",children:[(0,a.jsx)("div",{className:"flex-none px-6 py-4 border-b border-[#d5e5f6] dark:border-[#ffffff66] bg-[#ffffff99] dark:bg-[rgba(255,255,255,0.1)] backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("div",{className:"flex items-center gap-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/25",children:(0,a.jsx)(o.Z,{className:"text-white text-base"})}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-base font-semibold text-slate-800 dark:text-slate-100 tracking-tight",children:s("data_preview")}),I&&(0,a.jsx)(x.Z,{title:I,children:(0,a.jsx)("span",{className:"text-xs text-slate-500 dark:text-slate-400 truncate max-w-[200px]",children:I})})]})]})}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[L>0&&(0,a.jsxs)(p.Z,{color:"blue",className:"rounded-full px-3 py-0.5 text-xs font-medium border-0 bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400",children:[L," 个筛选"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 px-4 py-2 rounded-xl bg-white/60 dark:bg-[rgba(255,255,255,0.1)]",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("span",{className:"text-lg font-bold text-blue-600 dark:text-blue-400 tabular-nums",children:V.toLocaleString()}),(0,a.jsx)("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:s("rows")})]}),(0,a.jsx)("span",{className:"text-slate-300 dark:text-slate-600",children:"\xd7"}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("span",{className:"text-lg font-bold text-emerald-600 dark:text-emerald-400 tabular-nums",children:A}),(0,a.jsx)("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:s("columns")})]})]}),r&&(0,a.jsx)(x.Z,{title:"删除数据预览",children:(0,a.jsx)(f.ZP,{type:"text",icon:(0,a.jsx)(d.Z,{}),onClick:r,className:"flex items-center justify-center w-8 h-8 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-500 hover:text-red-500 dark:text-slate-400 dark:hover:text-red-400 transition-colors"})})]})]})}),T&&F&&F.length>1&&(0,a.jsx)("div",{className:"flex-none px-4 bg-[#ffffff99] dark:bg-[rgba(255,255,255,0.08)] border-b border-[#d5e5f6] dark:border-[#ffffff33]",children:(0,a.jsx)(g.Z,{activeKey:C,onChange:e=>{Z(e),y({}),w({}),S({})},size:"small",className:" excel-sheet-tabs [&_.ant-tabs-nav]:!mb-0 [&_.ant-tabs-nav::before]:!border-none [&_.ant-tabs-tab]:!py-2 [&_.ant-tabs-tab]:!px-4 [&_.ant-tabs-tab]:!mx-0.5 [&_.ant-tabs-tab]:!rounded-t-lg [&_.ant-tabs-tab]:!border [&_.ant-tabs-tab]:!border-b-0 [&_.ant-tabs-tab]:!border-transparent [&_.ant-tabs-tab]:!bg-transparent [&_.ant-tabs-tab]:!transition-all [&_.ant-tabs-tab:hover]:!bg-blue-50/50 [&_.ant-tabs-tab:hover]:dark:!bg-[rgba(255,255,255,0.08)] [&_.ant-tabs-tab-active]:!bg-white [&_.ant-tabs-tab-active]:dark:!bg-[rgba(255,255,255,0.15)] [&_.ant-tabs-tab-active]:!border-[#d5e5f6] [&_.ant-tabs-tab-active]:dark:!border-[#ffffff33] [&_.ant-tabs-tab-btn]:!text-slate-600 [&_.ant-tabs-tab-btn]:dark:!text-slate-300 [&_.ant-tabs-tab-active_.ant-tabs-tab-btn]:!text-blue-600 [&_.ant-tabs-tab-active_.ant-tabs-tab-btn]:dark:!text-blue-400 [&_.ant-tabs-tab-active_.ant-tabs-tab-btn]:!font-semibold [&_.ant-tabs-ink-bar]:!hidden ",items:F.map((e,t)=>{var l;return{key:String(t),label:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"truncate max-w-[120px]",title:e.sheet_name,children:e.sheet_name}),(0,a.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400",children:(null===(l=e.total)||void 0===l?void 0:l.toLocaleString())||0})]})}})})}),(0,a.jsx)("div",{className:"flex-1 min-h-0 overflow-hidden",children:(0,a.jsx)(b.Z,{columns:D,dataSource:O,rowKey:(e,t)=>String(t),onChange:(e,t,l)=>{w(Array.isArray(l)?l[0]:l)},pagination:{defaultPageSize:100,showSizeChanger:!0,pageSizeOptions:["50","100","200","500"],showQuickJumper:!0,showTotal:e=>(0,a.jsxs)("span",{className:"text-slate-500 dark:text-slate-400 text-sm",children:["共 ",e.toLocaleString()," 条记录"]}),className:"!mb-0 !pb-0 !px-4"},scroll:{x:!0,y:"calc(100vh - 200px)"},size:"middle",className:" h-full excel-preview-table [&_.ant-table-wrapper]:h-full  [&_.ant-table]:h-full  [&_.ant-table-container]:h-full [&_.ant-table-container]:!bg-transparent  [&_.ant-table-thead>tr>th]:!bg-white/80 [&_.ant-table-thead>tr>th]:dark:!bg-[rgba(255,255,255,0.12)] [&_.ant-table-thead>tr>th]:!border-b-2 [&_.ant-table-thead>tr>th]:!border-[#d5e5f6] [&_.ant-table-thead>tr>th]:dark:!border-[#ffffff66] [&_.ant-table-tbody>tr>td]:!bg-white/60 [&_.ant-table-tbody>tr>td]:dark:!bg-[rgba(255,255,255,0.08)] [&_.ant-table-tbody>tr:hover>td]:!bg-blue-50/50 [&_.ant-table-tbody>tr:hover>td]:dark:!bg-[rgba(255,255,255,0.12)] [&_.ant-table-tbody>tr>td]:!border-slate-100 [&_.ant-table-tbody>tr>td]:dark:!border-slate-800 [&_.ant-table-tbody>tr>td]:!py-2.5 [&_.ant-pagination]:!mt-0  [&_.ant-pagination]:!py-3 [&_.ant-pagination]:!bg-[#ffffff99] [&_.ant-pagination]:dark:!bg-[rgba(255,255,255,0.1)] [&_.ant-pagination]:!backdrop-blur-sm [&_.ant-pagination]:!border-t  [&_.ant-pagination]:!border-[#d5e5f6] [&_.ant-pagination]:dark:!border-[#ffffff66] [&_.ant-table-column-sorter]:!text-slate-400 [&_.ant-table-column-sorter-up.active]:!text-blue-500 [&_.ant-table-column-sorter-down.active]:!text-blue-500 "})})]})},y=()=>{let{excelPreviewData:e,setExcelPreviewVisible:t}=(0,n.useContext)(eZ);return(0,a.jsx)(j,{previewData:e,onDelete:()=>{null==t||t(!1)}})},N=e=>{let{leftPanel:t,rightPanel:l,defaultLeftWidth:r=60,minLeftWidth:s=30,maxLeftWidth:i=80}=e,[c,o]=(0,n.useState)(r),[d,u]=(0,n.useState)(!1),x=(0,n.useRef)(null),m=(0,n.useCallback)(()=>{u(!0)},[]),h=(0,n.useCallback)(e=>{if(!d||!x.current)return;let t=x.current,l=t.getBoundingClientRect(),a=(e.clientX-l.left)/l.width*100;a>=s&&a<=i&&o(a)},[d,s,i]),f=(0,n.useCallback)(()=>{u(!1)},[]);return(0,n.useEffect)(()=>(d?(document.addEventListener("mousemove",h),document.addEventListener("mouseup",f),document.body.style.userSelect="none",document.body.style.cursor="col-resize"):(document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",f),document.body.style.userSelect="",document.body.style.cursor=""),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",f),document.body.style.userSelect="",document.body.style.cursor=""}),[d,h,f]),(0,a.jsxs)("div",{ref:x,className:"flex h-full w-full",children:[(0,a.jsx)("div",{className:"h-full overflow-hidden",style:{width:"".concat(c,"%"),transition:d?"none":"width 0.1s ease"},children:t}),(0,a.jsxs)("div",{className:"relative flex-shrink-0 group cursor-col-resize",onMouseDown:m,style:{width:"4px"},children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-gray-200 dark:bg-gray-700 group-hover:bg-blue-400 dark:group-hover:bg-blue-500 transition-colors"}),(0,a.jsx)("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-1 h-12 bg-gray-400 dark:bg-gray-500 group-hover:bg-blue-500 dark:group-hover:bg-blue-400 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"})]}),(0,a.jsx)("div",{className:"h-full overflow-hidden",style:{width:"".concat(100-c,"%"),transition:d?"none":"width 0.1s ease"},children:l})]})},w=l(43446),k=l(62418),S=l(25035),C=l(24969),Z=l(45030),E=l(85576),T=l(11163),M=l(48218);let R=["magenta","orange","geekblue","purple","cyan","green"];var O=e=>{var t,l;let{isScrollToTop:i}=e,{appInfo:c,handleChat:o,scrollRef:d,temperatureValue:u,resourceValue:x,currentDialogue:h,refreshDialogList:f,setResourceValue:g,setHistory:b}=(0,n.useContext)(eZ),{model:_,setCurrentDialogInfo:j}=(0,n.useContext)(r.p),y=(0,T.useRouter)(),{t:N}=(0,v.$G)(),[w,O]=(0,n.useState)(!1),L=(0,n.useCallback)(async()=>{null==g||g(null),null==b||b([]),localStorage.removeItem(k.rU);let[,e]=await (0,s.Vx)((0,s.sW)({chat_mode:"chat_excel",model:_}));e&&(null==j||j({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),y.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(_?"&model=".concat(_):"")),null==f||f())},[_,y,j,f,g,b]),P=(0,n.useMemo)(()=>{var e;return(null==c?void 0:null===(e=c.team_context)||void 0===e?void 0:e.chat_scene)||"chat_agent"},[c]),z=(0,n.useMemo)(()=>"chat_excel"===P?N("chat_excel_app_name"):null==c?void 0:c.app_name,[P,null==c?void 0:c.app_name,N]),D=(0,n.useMemo)(()=>"chat_excel"===P?N("chat_excel_app_describe"):null==c?void 0:c.app_describe,[P,null==c?void 0:c.app_describe,N]),I=(0,n.useMemo)(()=>{var e;return(null===(e=c.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[c.param_need]);return Object.keys(c).length?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"h-20 mt-6 ".concat((null==c?void 0:c.recommend_questions)&&(null==c?void 0:null===(t=c.recommend_questions)||void 0===t?void 0:t.length)>0?"mb-6":""," sticky top-0 bg-transparent z-30 transition-all duration-400 ease-in-out"),children:i?(0,a.jsxs)("header",{className:"flex items-center justify-between w-full h-14 bg-[#f0f7ff] dark:bg-[#1a2332] px-8 transition-all duration-500 ease-in-out",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg mr-2 bg-white",children:(0,a.jsx)(M.Z,{scene:P})}),(0,a.jsxs)("div",{className:"flex items-center text-base text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] font-semibold gap-2",children:[(0,a.jsx)("span",{children:z}),(0,a.jsx)(m.Z,{content:N("help_doc"),children:(0,a.jsx)(S.Z,{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] hover:text-blue-500 dark:hover:text-blue-400 cursor-pointer transition-colors",onClick:()=>O(!0)})})]})]}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:(0,a.jsxs)("div",{onClick:L,className:"flex items-center gap-1.5 px-3 h-8 rounded-full cursor-pointer hover:bg-[#f0f0f0] dark:hover:bg-[rgba(255,255,255,0.2)]",children:[(0,a.jsx)(C.Z,{style:{fontSize:14}}),(0,a.jsx)("span",{className:"text-sm font-medium",children:N("new_chat")})]})})]}):(0,a.jsxs)("header",{className:"flex items-center justify-between w-5/6 h-full px-6  bg-[#ffffff99] border dark:bg-[rgba(255,255,255,0.1)] dark:border-[rgba(255,255,255,0.1)] rounded-2xl mx-auto transition-all duration-400 ease-in-out relative",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"flex w-12 h-12 justify-center items-center rounded-xl mr-4 bg-white",children:(0,a.jsx)(M.Z,{scene:P,width:16,height:16})}),(0,a.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center text-base text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] font-semibold gap-2",children:[(0,a.jsx)("span",{children:z}),(0,a.jsx)(m.Z,{content:N("help_doc"),children:(0,a.jsx)(S.Z,{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] hover:text-blue-500 dark:hover:text-blue-400 cursor-pointer transition-colors",onClick:()=>O(!0)})})]}),(0,a.jsx)(Z.default.Text,{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] leading-6",ellipsis:{tooltip:!0},children:D})]})]}),(0,a.jsx)("div",{className:"flex items-center gap-3",children:(0,a.jsxs)("div",{onClick:L,className:"flex items-center gap-2 px-4 h-10 bg-[#ffffff99] dark:bg-[rgba(255,255,255,0.2)] border border-white dark:border-[rgba(255,255,255,0.2)] rounded-full cursor-pointer hover:bg-[#f0f0f0] dark:hover:bg-[rgba(255,255,255,0.3)]",children:[(0,a.jsx)(C.Z,{style:{fontSize:16}}),(0,a.jsx)("span",{className:"text-sm font-medium",children:N("new_chat")})]})}),!!(null==c?void 0:null===(l=c.recommend_questions)||void 0===l?void 0:l.length)&&(0,a.jsxs)("div",{className:"absolute  bottom-[-40px] left-0",children:[(0,a.jsx)("span",{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] leading-6",children:N("maybe_you_want_to_ask")}),c.recommend_questions.map((e,t)=>(0,a.jsx)(p.Z,{color:R[t],className:"text-xs p-1 px-2 cursor-pointer",onClick:async()=>{o((null==e?void 0:e.question)||"",{app_code:c.app_code,...I.includes("temperature")&&{temperature:u},...I.includes("resource")&&{select_param:"string"==typeof x?x:JSON.stringify(x)||h.select_param}}),setTimeout(()=>{var e,t;null===(e=d.current)||void 0===e||e.scrollTo({top:null===(t=d.current)||void 0===t?void 0:t.scrollHeight,behavior:"smooth"})},0)},children:e.question},e.id))]})]})}),(0,a.jsx)(E.default,{title:N("chat_excel_help_title"),open:w,onCancel:()=>O(!1),footer:null,width:700,centered:!0,children:(0,a.jsxs)("div",{className:"space-y-4 py-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-base font-semibold mb-2 text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_features_title")}),(0,a.jsx)("p",{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] mb-2",children:N("chat_excel_features_desc")}),(0,a.jsxs)("ul",{className:"list-disc list-inside space-y-1 text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:[(0,a.jsx)("li",{children:N("chat_excel_feature_1")}),(0,a.jsx)("li",{children:N("chat_excel_feature_2")}),(0,a.jsx)("li",{children:N("chat_excel_feature_3")}),(0,a.jsx)("li",{children:N("chat_excel_feature_4")}),(0,a.jsx)("li",{children:N("chat_excel_feature_5")}),(0,a.jsx)("li",{children:N("chat_excel_feature_6")}),(0,a.jsx)("li",{children:N("chat_excel_feature_7")})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-base font-semibold mb-2 text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_workflow_title")}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-semibold flex-shrink-0 mt-0.5",children:"1"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_step_1_title")}),(0,a.jsx)("p",{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:N("chat_excel_step_1_desc")})]})]}),(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-semibold flex-shrink-0 mt-0.5",children:"2"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_step_2_title")}),(0,a.jsx)("p",{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:N("chat_excel_step_2_desc")})]})]}),(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-semibold flex-shrink-0 mt-0.5",children:"3"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_step_3_title")}),(0,a.jsx)("p",{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:N("chat_excel_step_3_desc")})]})]}),(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-semibold flex-shrink-0 mt-0.5",children:"4"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_step_4_title")}),(0,a.jsx)("p",{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:N("chat_excel_step_4_desc")})]})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-base font-semibold mb-2 text-[#1c2533] dark:text-[rgba(255,255,255,0.85)]",children:N("chat_excel_tips_title")}),(0,a.jsxs)("ul",{className:"list-disc list-inside space-y-1 text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)]",children:[(0,a.jsx)("li",{children:N("chat_excel_tip_1")}),(0,a.jsx)("li",{children:N("chat_excel_tip_2")}),(0,a.jsx)("li",{children:N("chat_excel_tip_3")}),(0,a.jsx)("li",{children:N("chat_excel_tip_4")}),(0,a.jsx)("li",{children:N("chat_excel_tip_5")})]})]})]})})]}):null},L=l(62635),P=l(66017),z=l(5152),D=l.n(z);let I=D()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(1265),l.e(568),l.e(4347),l.e(7562),l.e(3028),l.e(9720),l.e(8677),l.e(2438),l.e(9202),l.e(5265),l.e(5533),l.e(3764),l.e(188),l.e(9533),l.e(3768),l.e(5789),l.e(9562),l.e(4434),l.e(9958)]).then(l.bind(l,88331)),{loadableGenerated:{webpack:()=>[88331]},ssr:!1});var V=(0,n.forwardRef)((e,t)=>{let{className:l}=e,r=(0,n.useRef)(null),[s,i]=(0,n.useState)(!1),[c,o]=(0,n.useState)(!1),[d,u]=(0,n.useState)(!0),[x,m]=(0,n.useState)(!1),{history:h}=(0,n.useContext)(eZ),f=(0,n.useRef)(!0),p=(0,n.useRef)(null),g=(0,n.useRef)(null),b=(0,n.useRef)(0);(0,n.useImperativeHandle)(t,()=>r.current);let v=(0,n.useCallback)(()=>{var e;if(!r.current)return;let t=r.current,l=t.scrollTop,a=t.scrollHeight,s=t.clientHeight,n=Number(null==t?void 0:null===(e=t.dataset)||void 0===e?void 0:e.lastScrollTop)||0,c=l>n?"down":"up";t.dataset.lastScrollTop=String(l);let d=l+s>=a-40;f.current="down"===c||d,u(l<=20),m(l+s>=a-20),l>=74?i(!0):i(!1);let x=a>s;o(x)},[]);(0,n.useEffect)(()=>{let e=r.current;if(e){e.addEventListener("scroll",v);let t=e.scrollHeight>e.clientHeight;o(t)}return()=>{e&&e.removeEventListener("scroll",v)}},[v]);let _=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!r.current||!e&&!f.current)return;let t=r.current,{scrollTop:l,scrollHeight:a,clientHeight:s}=t;if(!(l+s>=a-Math.max(50,.1*s))&&!e)return;g.current&&(clearTimeout(g.current),g.current=null),p.current&&cancelAnimationFrame(p.current);let n=()=>{if(r.current){let t=r.current.scrollHeight;r.current.scrollTo({top:t,behavior:e?"smooth":"auto"}),r.current.scrollTop<t-10&&(r.current.scrollTop=t),b.current=t}};p.current=requestAnimationFrame(()=>{n(),g.current=setTimeout(()=>{n(),setTimeout(()=>{if(r.current){let e=r.current.scrollHeight;e!==b.current&&n()}},100),g.current=null},50),p.current=null})},[]),j=(0,n.useMemo)(()=>{let e=h[h.length-1];return e?{context:e.context,thinking:e.thinking,role:e.role}:null},[h]),y=(0,n.useRef)(h.length),N=(0,n.useRef)("");(0,n.useEffect)(()=>{let e=h.length,t=e>y.current,l=j?"".concat(j.role,"-").concat(j.context,"-").concat(j.thinking):"",a=l!==N.current;t?(f.current=!0,y.current=e,N.current=l,setTimeout(()=>{_(!0)},0),setTimeout(()=>{_(!0)},100),setTimeout(()=>{_(!0)},300)):a&&(N.current=l,setTimeout(()=>{_(!1)},0),setTimeout(()=>{_(!1)},100))},[h.length,null==j?void 0:j.context,null==j?void 0:j.thinking,null==j?void 0:j.role,_]);let w=(0,n.useRef)(!1),k=(0,n.useRef)(null);(0,n.useEffect)(()=>((null==j?void 0:j.context)&&(w.current=!0,k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{w.current=!1},1e3)),()=>{k.current&&clearTimeout(k.current)}),[null==j?void 0:j.context]),(0,n.useEffect)(()=>{if(!r.current)return;let e=r.current,t=null,l=()=>{if(!e||!w.current)return;let l=e.scrollHeight,a=l!==b.current;a&&(b.current=l,f.current&&(t=setTimeout(()=>{e&&w.current&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},50),requestAnimationFrame(()=>{e&&w.current&&e.scrollTo({top:e.scrollHeight,behavior:"auto"})})))},a=new ResizeObserver(()=>{l()}),s=new MutationObserver(()=>{l()});a.observe(e),s.observe(e,{childList:!0,subtree:!0,characterData:!0});let n=setInterval(()=>{w.current&&l()},200);return()=>{a.disconnect(),s.disconnect(),clearInterval(n),t&&clearTimeout(t)}},[]),(0,n.useEffect)(()=>()=>{p.current&&cancelAnimationFrame(p.current),g.current&&clearTimeout(g.current)},[]);let S=(0,n.useCallback)(()=>{r.current&&r.current.scrollTo({top:0,behavior:"smooth"})},[]),C=(0,n.useCallback)(()=>{r.current&&r.current.scrollTo({top:r.current.scrollHeight,behavior:"smooth"})},[]);return(0,a.jsxs)("div",{className:"flex flex-1 overflow-hidden relative ".concat(l||""),children:[(0,a.jsxs)("div",{ref:r,className:"h-full w-full mx-auto overflow-y-auto",children:[(0,a.jsx)(O,{isScrollToTop:s}),(0,a.jsx)(I,{})]}),c&&(0,a.jsxs)("div",{className:"absolute right-4 md:right-6 bottom-[120px] md:bottom-[100px] flex flex-col gap-2 z-[999]",children:[!d&&(0,a.jsx)("button",{onClick:S,className:"w-9 h-9 md:w-10 md:h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-200","aria-label":"Scroll to top",children:(0,a.jsx)(L.Z,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)] text-sm md:text-base"})}),!x&&(0,a.jsx)("button",{onClick:C,className:"w-9 h-9 md:w-10 md:h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-200","aria-label":"Scroll to bottom",children:(0,a.jsx)(P.Z,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)] text-sm md:text-base"})})]})]})}),A=l(33160),F=l(50888),H=l(93967),J=l.n(H),q=l(39332),G=l(30159),W=l(48689),$=l(52645),U=l(99611),K=l(90420),B=l(45360),Q=l(25675),Y=l.n(Q),X=l(23430),ee=l(90725),et=l(83266),el=l(65654),ea=l(2093),er=l(23799),es=l(34041),en=(0,n.memo)(e=>{var t,l,r,i;let{fileList:c,setFileList:o,setLoading:d,fileName:u}=e,{setResourceValue:m,appInfo:h,refreshHistory:f,refreshDialogList:p,modelValue:g,resourceValue:b,setExcelPreviewData:_}=(0,n.useContext)(eZ),{temperatureValue:j,maxNewTokensValue:y}=(0,n.useContext)(eZ),N=(0,q.useSearchParams)(),w=null!==(t=null==N?void 0:N.get("scene"))&&void 0!==t?t:"",S=null!==(l=null==N?void 0:N.get("id"))&&void 0!==l?l:"",{t:C}=(0,v.$G)(),[Z,E]=(0,n.useState)([]),T=(0,n.useMemo)(()=>{var e;return(null===(e=h.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[h.param_need]),M=(0,n.useMemo)(()=>{var e,t;return T.includes("resource")&&(null===(e=null===(t=h.param_need)||void 0===t?void 0:t.filter(e=>"resource"===e.type)[0])||void 0===e?void 0:e.value)==="database"},[h.param_need,T]),R=(0,n.useMemo)(()=>{var e,t;return T.includes("resource")&&(null===(e=null===(t=h.param_need)||void 0===t?void 0:t.filter(e=>"resource"===e.type)[0])||void 0===e?void 0:e.value)==="knowledge"},[h.param_need,T]),O=(0,n.useMemo)(()=>{var e;return null===(e=h.param_need)||void 0===e?void 0:e.find(e=>"resource"===e.type)},[h.param_need]),{run:L,loading:P}=(0,el.Z)(async()=>await (0,s.Vx)((0,s.vD)(w)),{manual:!0,onSuccess:e=>{let[,t]=e;E(null!=t?t:[])}});(0,ea.Z)(async()=>{(M||R)&&!(null==O?void 0:O.bind_value)&&await L()},[M,R,O]);let z=(0,n.useMemo)(()=>{var e;return null===(e=Z.map)||void 0===e?void 0:e.call(Z,e=>({label:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(X.Z,{width:24,height:24,src:k.S$[e.type].icon,label:k.S$[e.type].label,className:"w-[1.5em] h-[1.5em] mr-1 inline-block mt-[-4px]"}),e.param]}),value:e.param}))},[Z]),D=(0,n.useCallback)(async()=>{var e;let t=new FormData;t.append("doc_files",null==c?void 0:c[0]),d(!0);let l=(null==c?void 0:null===(e=c[0])||void 0===e?void 0:e.name)||"",a=/\.(xlsx|xls)$/i.test(l),[r,n]=await (0,s.Vx)((0,s.qn)({convUid:S,chatMode:w,data:t,model:g,temperatureValue:j,maxNewTokensValue:y,multiTableMode:!!a||void 0,config:{timeout:36e5}})).finally(()=>{d(!1)});if(n){if(m(n),n.preview_data){console.log("✅ 设置Excel预览数据:",n.preview_data);let e={...n.preview_data,file_name:n.preview_data.file_name||n.file_name||l};null==_||_(e)}await f(),await p()}},[S,c,g,p,f,w,d,m,_,j,y]);if(!T.includes("resource"))return(0,a.jsx)(x.Z,{title:C("extend_tip"),children:(0,a.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)]",children:(0,a.jsx)(ee.Z,{className:"text-lg cursor-not-allowed opacity-30"})})});switch(null==O?void 0:O.value){case"excel_file":case"text_file":case"image_file":case"audio_file":case"video_file":{let e="chat_excel"===w&&(!!u||!!(null===(r=c[0])||void 0===r?void 0:r.name)),t=C("chat_excel"===w?"file_tip":"file_upload_tip");return(0,a.jsx)(er.default,{name:"file",accept:(()=>{switch(null==O?void 0:O.value){case"excel_file":return".csv,.xlsx,.xls";case"text_file":return".txt,.doc,.docx,.pdf,.md";case"image_file":return".jpg,.jpeg,.png,.gif,.bmp,.webp";case"audio_file":return".mp3,.wav,.ogg,.aac";case"video_file":return".mp4,.wav,.wav";default:return""}})(),fileList:c,showUploadList:!1,beforeUpload:(e,t)=>{null==o||o(t)},customRequest:D,disabled:e,children:(0,a.jsx)(x.Z,{title:t,arrow:!1,placement:"bottom",children:(0,a.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)]",children:(0,a.jsx)(et.Z,{className:J()("text-xl",{"cursor-pointer":!e})})})})})}case"database":case"knowledge":case"plugin":case"awel_flow":return b||m(null==z?void 0:null===(i=z[0])||void 0===i?void 0:i.value),(0,a.jsx)(es.default,{value:b,className:"w-52 h-8 rounded-3xl",onChange:e=>{m(e)},disabled:!!(null==O?void 0:O.bind_value),loading:P,options:z})}}),ei=e=>{var t,l;let{ctrl:r,onLoadingChange:i}=e,{t:c}=(0,v.$G)(),o=(0,q.useSearchParams)(),d=null!==(t=null==o?void 0:o.get("id"))&&void 0!==t?t:"",m=null!==(l=null==o?void 0:o.get("scene"))&&void 0!==l?l:"",{history:h,scrollRef:f,canAbort:p,replyLoading:g,currentDialogue:b,appInfo:_,temperatureValue:j,maxNewTokensValue:y,resourceValue:N,excelPreviewData:w,excelPreviewVisible:S,setTemperatureValue:C,setMaxNewTokensValue:Z,setExcelPreviewVisible:T,refreshHistory:M,setCanAbort:R,setReplyLoading:O,handleChat:L}=(0,n.useContext)(eZ),[P,z]=(0,n.useState)([]),[D,I]=(0,n.useState)(!1),[V,A]=(0,n.useState)(!1),[H,Q]=(0,n.useState)(!1);n.useEffect(()=>{z([])},[d]),n.useEffect(()=>{null==i||i(D)},[D,i]);let X=(0,n.useMemo)(()=>{var e;return(null===(e=_.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[_.param_need]),ee=(0,n.useMemo)(()=>[{tip:c("stop_replying"),icon:(0,a.jsx)(G.Z,{className:J()({"text-[#0c75fc]":p})}),can_use:p,key:"abort",onClick:()=>{p&&(r.abort(),setTimeout(()=>{R(!1),O(!1)},100))}},{tip:c("clear_all_caches"),icon:H?(0,a.jsx)(u.Z,{spinning:H,indicator:(0,a.jsx)(F.Z,{style:{fontSize:20}})}):(0,a.jsx)(W.Z,{}),can_use:!g,key:"clear_all_caches",onClick:async()=>{H||E.default.confirm({title:(0,a.jsx)("div",{children:(0,a.jsx)("div",{style:{marginBottom:"8px"},children:c("clear_all_caches_content")})}),content:(0,a.jsxs)("div",{children:[(0,a.jsxs)("ul",{style:{paddingLeft:"20px",margin:"10px 0"},children:[(0,a.jsx)("li",{children:c("clear_cache_excel_db")}),(0,a.jsx)("li",{children:c("clear_cache_excel_files")}),(0,a.jsx)("li",{children:c("clear_cache_uploaded_excel")}),(0,a.jsx)("li",{children:c("clear_cache_excel_temp_db")}),(0,a.jsx)("li",{children:c("clear_cache_chat_history")}),(0,a.jsx)("li",{children:c("clear_cache_file_server")}),(0,a.jsx)("li",{children:c("clear_cache_model")})]}),(0,a.jsx)("p",{style:{color:"red",fontWeight:"bold"},children:c("clear_cache_warning")})]}),okText:c("confirm_clear"),cancelText:c("cancel"),okType:"danger",onOk:async()=>{Q(!0);try{await (0,s.Vx)((0,s.YG)()),B.ZP.success(c("clear_cache_success")),setTimeout(()=>{window.location.reload()},3e3)}catch(e){B.ZP.error("".concat(c("clear_cache_failed"),": ").concat((null==e?void 0:e.message)||c("unknown_error")))}finally{Q(!1)}}})}},{tip:c("erase_memory"),icon:V?(0,a.jsx)(u.Z,{spinning:V,indicator:(0,a.jsx)(F.Z,{style:{fontSize:20}})}):(0,a.jsx)($.Z,{}),can_use:h.length>0,key:"clear",onClick:async()=>{V||(A(!0),await (0,s.Vx)((0,s.zR)(b.conv_uid)).finally(async()=>{await M(),A(!1)}))}}],[c,p,g,h,V,r,R,O,L,_.app_code,X,j,N,b.select_param,b.conv_uid,f,M]),et=(0,n.useMemo)(()=>{try{if(N){if("string"!=typeof N)return N.file_name||N.original_filename||"";{let e=JSON.parse(N);return e.file_name||e.original_filename||""}}if((null==b?void 0:b.select_param)&&(null==b?void 0:b.conv_uid)===d){let e=JSON.parse(b.select_param);return e.file_name||e.original_filename||""}return""}catch(e){return""}},[N,null==b?void 0:b.select_param,null==b?void 0:b.conv_uid,d]),el=(0,n.useMemo)(()=>{let e=(null==b?void 0:b.select_param)&&(null==b?void 0:b.conv_uid)===d?b.select_param:null,t=(0,k.Ev)(N)||(0,k.Ev)(e)||[];return t.filter(e=>{var t;return"file_url"===e.type&&(null===(t=e.file_url)||void 0===t?void 0:t.url)})},[N,null==b?void 0:b.select_param,null==b?void 0:b.conv_uid,d]),ea=(0,n.useMemo)(()=>{let e=(null==b?void 0:b.select_param)&&(null==b?void 0:b.conv_uid)===d?b.select_param:null,t=(0,k.Ev)(N)||(0,k.Ev)(e)||[];return t.filter(e=>{var t;return"image_url"===e.type&&(null===(t=e.image_url)||void 0===t?void 0:t.url)})},[N,null==b?void 0:b.select_param,null==b?void 0:b.conv_uid,d]);return(0,a.jsxs)("div",{className:"flex flex-col  mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between h-full w-full",children:[(0,a.jsxs)("div",{className:"flex gap-3 text-lg items-center",children:[(0,a.jsx)(en,{fileList:P,setFileList:z,setLoading:I,fileName:et}),D&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(u.Z,{spinning:D,indicator:(0,a.jsx)(F.Z,{style:{fontSize:14},spin:!0})}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:c("parsing_data")})]}),(0,a.jsx)(()=>{if(0===el.length)return null;let e=(e,t)=>{e&&(null==t||t.stopPropagation(),null==t||t.preventDefault(),w?null==T||T(!S):null==T||T(!0))},t=(t,l)=>{t&&e(t,l)};return(0,a.jsx)(a.Fragment,{children:el.map((l,r)=>{var s;let n=null===(s=l.file_url)||void 0===s?void 0:s.file_name,i=/\.(xlsx?|csv)$/i.test(n||"");return(0,a.jsx)(x.Z,{title:i?w?S?"关闭预览":"查看数据":"点击查看预览":"",children:(0,a.jsx)("div",{className:J()("flex items-center justify-between border border-[#e3e4e6] dark:border-[rgba(255,255,255,0.6)] rounded-lg p-2 relative",{"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors":i}),onClick:t=>e(i,t),onClickCapture:e=>t(i,e),style:{zIndex:i?9999:"auto",pointerEvents:"auto",position:i?"relative":"static"},children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(Y(),{src:"/icons/chat/excel.png",width:20,height:20,alt:"file-icon",className:"mr-2"}),(0,a.jsx)("span",{className:"text-sm text-[#1c2533] dark:text-white line-clamp-1",children:n}),i&&(w&&S?(0,a.jsx)(U.Z,{className:"ml-2 text-blue-500"}):(0,a.jsx)(K.Z,{className:"ml-2 text-gray-400 hover:text-blue-500"}))]})})},"file-".concat(r))})})},{}),"chat_excel"===m&&!et&&0===el.length&&!D&&(0,a.jsx)("span",{className:"text-sm text-gray-400 dark:text-gray-500",children:c("upload_excel_prompt")})]}),(0,a.jsx)("div",{className:"flex gap-1",children:(0,a.jsx)(a.Fragment,{children:ee.map(e=>(0,a.jsx)(x.Z,{title:e.tip,arrow:!1,placement:"bottom",children:(0,a.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)] text-lg ".concat(e.can_use?"cursor-pointer":"opacity-30 cursor-not-allowed"),onClick:()=>{var t;null===(t=e.onClick)||void 0===t||t.call(e)},children:e.icon})},e.key))})})]}),(0,a.jsx)(()=>0===ea.length?null:(0,a.jsx)("div",{className:"group/item flex flex-wrap gap-2 mt-2",children:ea.map((e,t)=>{let l=e.image_url.fileName,r=(0,k.Hb)(e.image_url.url);return(0,a.jsxs)("div",{className:"flex flex-col border border-[#e3e4e6] dark:border-[rgba(255,255,255,0.6)] rounded-lg p-2",children:[(0,a.jsx)("div",{className:"w-32 h-32 mb-2 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded",children:(0,a.jsx)("img",{src:r,alt:l||"Preview",className:"max-w-full max-h-full object-contain"})}),(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)("span",{className:"text-sm text-[#1c2533] dark:text-white line-clamp-1",children:l})})]},"img-".concat(t))})}),{})]})},ec=(0,n.forwardRef)((e,t)=>{var l,r,s;let{ctrl:i}=e,{t:c,i18n:o}=(0,v.$G)(),{replyLoading:d,handleChat:x,appInfo:m,currentDialogue:p,temperatureValue:g,maxNewTokensValue:b,resourceValue:_,setResourceValue:j,refreshDialogList:y,history:N,scrollRef:w}=(0,n.useContext)(eZ),S=(0,q.useSearchParams)(),C=null!==(l=null==S?void 0:S.get("scene"))&&void 0!==l?l:"",Z=null!==(r=null==S?void 0:S.get("select_param"))&&void 0!==r?r:"",E=null!==(s=null==S?void 0:S.get("id"))&&void 0!==s?s:"",[T,M]=(0,n.useState)(""),[R,O]=(0,n.useState)(!1),[L,P]=(0,n.useState)(!1),[z,D]=(0,n.useState)(!1),[I,V]=(0,n.useState)([]),[H,G]=(0,n.useState)(!1),[W,$]=(0,n.useState)([]),[U,K]=(0,n.useState)([]),B=(0,n.useRef)(""),Q=(0,n.useRef)(""),Y=(0,n.useRef)(o.language),X=(0,n.useRef)(0),ee=(0,n.useMemo)(()=>{var e;return(null===(e=m.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[m.param_need]),et=(0,n.useMemo)(()=>{if("chat_excel"!==C)return!0;try{if(_){if("string"==typeof _){let e=JSON.parse(_);if(e.file_name||e.original_filename)return!0}else if(_.file_name||_.original_filename)return!0}if((null==p?void 0:p.select_param)&&(null==p?void 0:p.conv_uid)===E){let e=JSON.parse(p.select_param);if(e.file_name||e.original_filename)return!0}let e=(null==p?void 0:p.select_param)&&(null==p?void 0:p.conv_uid)===E?p.select_param:null,t=(0,k.Ev)(_)||(0,k.Ev)(e)||[],l=t.filter(e=>{var t;return"file_url"===e.type&&(null===(t=e.file_url)||void 0===t?void 0:t.url)});if(l.length>0)return!0;return!1}catch(e){return!1}},[C,_,null==p?void 0:p.select_param,null==p?void 0:p.conv_uid,E]);(0,n.useEffect)(()=>{let e=(null==p?void 0:p.conv_uid)||"";e&&B.current&&e!==B.current?(V([]),K([]),$([]),B.current=e):!e&&B.current?(V([]),K([]),$([]),B.current=""):e&&!B.current&&(B.current=e)},[null==p?void 0:p.conv_uid]),(0,n.useEffect)(()=>{o.language!==Y.current&&(V([]),K([]),$([]),Y.current=o.language)},[o.language]),(0,n.useEffect)(()=>{if("chat_excel"!==C||!N||0===N.length)return;let e=N.filter(e=>"view"===e.role&&e.context);if(0===e.length)return;let t=e.reduce((e,t)=>(t.order||0)>(e.order||0)?t:e);if(!t||!t.context)return;let l=t.context,a="string"==typeof l?l:JSON.stringify(l),r="".concat(t.order,"_").concat(a.slice(-500));if(r===Q.current&&a.includes("<!--SUGGESTED_QUESTIONS:"))return;let s="<!--SUGGESTED_QUESTIONS:",n=a.indexOf(s);if(-1!==n){let e=n+s.length,t=a.substring(e),l=t.lastIndexOf("-->");if(l>0){let e=t.substring(0,l);try{let t=JSON.parse(e),l=t.suggested_questions||[];if(Array.isArray(l)&&l.length>0){K(l);let e=ea(l);V(e),$(e),Q.current=r;return}}catch(t){let e=a.match(/<!--SUGGESTED_QUESTIONS:(\{[\s\S]*?\})-->/);if(e)try{let t=JSON.parse(e[1]),l=t.suggested_questions||[];if(Array.isArray(l)&&l.length>0){K(l);let e=ea(l);V(e),$(e),Q.current=r;return}}catch(e){}}}}Q.current=r},[N,C]);let el=(0,n.useMemo)(()=>{if("chat_excel"!==C)return[];try{let e="";if(_?e="string"==typeof _?_:JSON.stringify(_):(null==p?void 0:p.select_param)&&(null==p?void 0:p.conv_uid)===E&&(e=p.select_param),!e)return[];let t={};try{t="string"==typeof e?JSON.parse(e):e}catch(e){return[]}let l=t.data_schema_json;if(!l)return[];let a={};try{a="string"==typeof l?JSON.parse(l):l}catch(e){return[]}let r="en"===o.language,s=[];return(s=r?a.suggested_questions_en||[]:a.suggested_questions_zh||[])&&0!==s.length||(s=a.suggested_questions||[]),Array.isArray(s)?s:[]}catch(e){return[]}},[C,_,p,E,o.language]),ea=e=>{if(e.length<=3)return e;let t=e.slice(0,6),l=e.slice(6,9),a=[...t].sort(()=>Math.random()-.5),r=a.slice(0,2),s=[...l].sort(()=>Math.random()-.5),n=s.slice(0,1);return[...r,...n]};(0,n.useEffect)(()=>{if(el.length>0&&0===U.length&&0===I.length){K(el);let e=ea(el);$(e)}},[el,U.length,I.length]);let er=(0,n.useMemo)(()=>I.length>0?W.length>0?W:I:el.length>0?W.length>0?W:ea(el):[],[I,el,W]),es=async e=>{!e.trim()||d||z||(await en(e),setTimeout(()=>{var e,t;null===(e=w.current)||void 0===e||e.scrollTo({top:null===(t=w.current)||void 0===t?void 0:t.scrollHeight,behavior:"smooth"})},100))},en=async e=>{let t;X.current++;let l=e||T;M("");let a=(0,k.Ev)(_);if(a.length>0){"chat_excel"!==C&&j(null);let e=[...a];e.push({type:"text",text:l}),t={role:"user",content:e}}else t=l;let r={app_code:m.app_code||"",...ee.includes("temperature")&&{temperature:g},...ee.includes("max_new_tokens")&&{max_new_tokens:b},select_param:Z,...ee.includes("resource")&&{select_param:"string"==typeof _?_:JSON.stringify(_)||p.select_param}};await x(t,r),1===X.current&&await y()};return(0,n.useImperativeHandle)(t,()=>({setUserInput:M})),(0,a.jsxs)("div",{className:"flex flex-col w-5/6 mx-auto pt-4 pb-6 bg-transparent",children:[er.length>0&&(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex items-center gap-1.5 flex-shrink-0 py-1",children:(0,a.jsx)("span",{className:"text-[13px] text-slate-500 dark:text-slate-400 whitespace-nowrap",children:c("maybe_you_want_to_ask")||"或许你想问"})}),(0,a.jsxs)("div",{className:"flex-1 flex flex-wrap items-center gap-2",children:[er.map((e,t)=>(0,a.jsx)("div",{className:"inline-flex items-center px-3 py-1.5 bg-white/70 dark:bg-[rgba(255,255,255,0.08)] border border-slate-200/80 dark:border-[rgba(255,255,255,0.15)] rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-300 dark:hover:border-blue-500/40 transition-all duration-200 group/item",onClick:()=>es(e),children:(0,a.jsx)("span",{className:"text-[13px] text-slate-600 dark:text-slate-300 group-hover/item:text-blue-600 dark:group-hover/item:text-blue-400 transition-colors leading-5",children:e})},t)),(0,a.jsxs)("div",{onClick:()=>{let e=U.length>0?U:el.length>0?el:[];if(e.length>0){let t=ea(e);$(t)}},className:"inline-flex items-center gap-1 px-2.5 py-1.5 text-slate-400 dark:text-slate-500 hover:text-blue-500 dark:hover:text-blue-400 cursor-pointer transition-colors",title:c("refresh_questions_tip"),children:[(0,a.jsx)(A.Z,{className:"text-xs"}),(0,a.jsx)("span",{className:"text-xs",children:c("refresh_questions")})]})]})]})}),(0,a.jsxs)("div",{className:"flex flex-1 flex-col bg-white dark:bg-[rgba(255,255,255,0.16)] px-5 py-4 pt-2 rounded-xl relative border-t border-b border-l border-r dark:border-[rgba(255,255,255,0.6)] ".concat(R?"border-[#0c75fc]":""),id:"input-panel",children:[(0,a.jsx)(ei,{ctrl:i,onLoadingChange:D}),et&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(h.default.TextArea,{placeholder:c("input_tips"),className:"w-full h-20 resize-none border-0 p-0 focus:shadow-none dark:bg-transparent",value:T,onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&!L&&(e.preventDefault(),!T.trim()||d||z||en())},onChange:e=>{M(e.target.value)},onFocus:()=>{O(!0)},onBlur:()=>O(!1),onCompositionStart:()=>P(!0),onCompositionEnd:()=>P(!1)}),(0,a.jsx)(f.ZP,{type:"primary",className:J()("flex items-center justify-center w-14 h-8 rounded-lg text-sm absolute right-4 bottom-3 bg-button-gradient border-0",{"cursor-not-allowed":!T.trim()||z,"opacity-40":z}),disabled:z,onClick:()=>{!d&&T.trim()&&!z&&en()},children:d?(0,a.jsx)(u.Z,{spinning:d,indicator:(0,a.jsx)(F.Z,{className:"text-white"})}):c("sent")})]})]})]})}),eo=l(82353),ed=l(25519),eu=l(14313),ex=l(94155),em=l(16165),eh=l(10524),ef=l(21612),ep=l(86250),eg=l(30381),eb=l.n(eg);l(83839);var ev=l(41664),e_=l.n(ev);let{Sider:ej}=ef.default,ey={display:"flex",alignItems:"center",justifyContent:"center",width:16,height:48,position:"absolute",top:"50%",transform:"translateY(-50%)",border:"1px solid #d6d8da",borderRadius:8,right:-8},eN=e=>{var t,l;let{item:i,refresh:c,historyLoading:o}=e,{t:d}=(0,v.$G)(),u=(0,q.useRouter)(),m=(0,q.useSearchParams)(),h=null!==(t=null==m?void 0:m.get("id"))&&void 0!==t?t:"",f=null!==(l=null==m?void 0:m.get("scene"))&&void 0!==l?l:"",{setCurrentDialogInfo:p}=(0,n.useContext)(r.p),g=(0,n.useMemo)(()=>i.default?i.default&&!h&&!f:i.conv_uid===h&&i.chat_mode===f,[h,f,i]),b=()=>{E.default.confirm({title:d("delete_chat"),content:d("delete_chat_confirm"),centered:!0,onOk:async()=>{let[e]=await (0,s.Vx)((0,s.MX)(i.conv_uid));e||(await (null==c?void 0:c()),i.conv_uid===h&&u.push("/chat"))}})};return(0,a.jsxs)(ep.Z,{align:"center",className:"group/item w-full h-12 p-3 rounded-lg  hover:bg-white dark:hover:bg-theme-dark cursor-pointer mb-2 relative ".concat(g?"bg-white dark:bg-theme-dark bg-opacity-100":""),onClick:()=>{o||(i.default||null==p||p({chat_scene:i.chat_mode,app_code:i.app_code}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:i.chat_mode,app_code:i.app_code})),u.push(i.default?"/chat":"?scene=".concat(i.chat_mode,"&id=").concat(i.conv_uid)))},children:[(0,a.jsx)(x.Z,{title:i.chat_mode,children:(0,a.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg mr-3 bg-white",children:i.icon})}),(0,a.jsx)("div",{className:"flex flex-1 line-clamp-1",children:(0,a.jsx)(Z.default.Text,{ellipsis:{tooltip:!0},children:i.label})}),!i.default&&(0,a.jsx)("div",{className:"flex gap-1 ml-1",children:(0,a.jsx)("div",{className:"group-hover/item:opacity-100 cursor-pointer opacity-0",onClick:e=>{e.stopPropagation(),b()},children:(0,a.jsx)(W.Z,{style:{fontSize:16}})})}),(0,a.jsx)("div",{className:" w-1 rounded-sm bg-[#0c75fc] absolute top-1/2 left-0 -translate-y-1/2 transition-all duration-500 ease-in-out ".concat(g?"h-5":"w-0 h-0")})]})};var ew=e=>{var t;let{dialogueList:l=[],refresh:i,historyLoading:c,listLoading:o,order:d}=e,h=(0,q.useRouter)(),f=(0,q.useSearchParams)(),p=null!==(t=null==f?void 0:f.get("scene"))&&void 0!==t?t:"",{t:g,i18n:b}=(0,v.$G)(),{mode:_,setMode:j,model:y,setCurrentDialogInfo:N}=(0,n.useContext)(r.p),{setResourceValue:w,setHistory:k}=(0,n.useContext)(eZ),[S,Z]=(0,n.useState)("chat_dashboard"===p),E=(0,n.useCallback)(async()=>{null==w||w(null),null==k||k([]),localStorage.removeItem(ed.rU);let[,e]=await (0,s.Vx)((0,s.sW)({chat_mode:"chat_excel",model:y}));e&&(null==N||N({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),h.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(y?"&model=".concat(y):"")),null==i||i())},[y,h,N,i,w,k]),T=(0,n.useCallback)(()=>{let e="light"===_?"dark":"light";j(e),localStorage.setItem(ed.he,e)},[_,j]),R=(0,n.useCallback)(()=>{let e="en"===b.language?"zh":"en";b.changeLanguage(e),"zh"===e&&eb().locale("zh-cn"),"en"===e&&eb().locale("en"),localStorage.setItem(ed.Yl,e)},[b]),O=(0,n.useMemo)(()=>S?{...ey,right:-16,borderRadius:"0px 8px 8px 0",borderLeft:"1px solid #d5e5f6"}:{...ey,borderLeft:"1px solid #d6d8da"},[S]),L=(0,n.useMemo)(()=>{let e=l[1]||[];return(null==e?void 0:e.length)>0?e.map(e=>({...e,label:e.user_input||e.select_param,key:e.conv_uid,icon:(0,a.jsx)(M.Z,{scene:e.chat_mode}),default:!1})):[]},[l]);return(0,a.jsx)(ej,{className:"bg-[#ffffff80] border-r border-[#d5e5f6] dark:bg-[#ffffff29] dark:border-[#ffffff66]",theme:_,width:280,collapsible:!0,collapsed:S,collapsedWidth:0,trigger:S?(0,a.jsx)(eu.Z,{className:"text-base"}):(0,a.jsx)(ex.Z,{className:"text-base"}),zeroWidthTriggerStyle:O,onCollapse:e=>Z(e),children:(0,a.jsxs)("div",{className:"flex flex-col h-full w-full bg-transparent",children:[(0,a.jsx)("div",{className:"px-4 pt-4 pb-4",children:(0,a.jsx)(e_(),{href:"/",className:"flex items-center justify-center",children:(0,a.jsx)(Y(),{src:"/finai_logo.png",alt:"FinAI",width:180,height:45})})}),(0,a.jsx)("div",{className:"px-4 pt-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("div",{className:"text-base font-semibold text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] line-clamp-1",children:g("dialog_list")}),(0,a.jsx)(x.Z,{title:g("new_chat"),children:(0,a.jsx)("div",{onClick:E,className:"flex items-center justify-center w-7 h-7 rounded-md bg-[#0c75fc] hover:bg-[#0a5fd4] text-white cursor-pointer",children:(0,a.jsx)(C.Z,{style:{fontSize:14}})})})]})}),(0,a.jsx)(ep.Z,{flex:1,vertical:!0,className:"overflow-y-auto px-4",children:(0,a.jsx)(u.Z,{spinning:o,className:"mt-2",children:!!(null==L?void 0:L.length)&&L.map(e=>(0,a.jsx)(eN,{item:e,refresh:i,historyLoading:c,order:d},null==e?void 0:e.key))})}),(0,a.jsx)("div",{className:"px-4 py-2 border-t border-dashed border-gray-200 dark:border-gray-700",children:(0,a.jsxs)("div",{className:"flex items-center justify-end gap-1",children:[(0,a.jsx)(m.Z,{content:g("Theme"),children:(0,a.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-md hover:bg-[#F1F5F9] dark:hover:bg-theme-dark cursor-pointer text-lg",onClick:T,children:"dark"===_?(0,a.jsx)(em.Z,{component:eo.FD}):(0,a.jsx)(em.Z,{component:eo.ol})})}),(0,a.jsx)(m.Z,{content:g("language"),children:(0,a.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-md hover:bg-[#F1F5F9] dark:hover:bg-theme-dark cursor-pointer text-lg",onClick:R,children:(0,a.jsx)(eh.Z,{})})})]})})]})})};let ek=D()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(4347),l.e(7562),l.e(3028),l.e(3764),l.e(188),l.e(3768),l.e(4434),l.e(7760)]).then(l.bind(l,47760)),{loadableGenerated:{webpack:()=>[47760]},ssr:!1}),eS=D()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(1265),l.e(568),l.e(4347),l.e(7562),l.e(3028),l.e(9720),l.e(8677),l.e(2438),l.e(9202),l.e(5265),l.e(5533),l.e(3764),l.e(188),l.e(7258),l.e(3768),l.e(5789),l.e(9562),l.e(4434),l.e(6660)]).then(l.bind(l,8334)),{loadableGenerated:{webpack:()=>[8334]},ssr:!1}),{Content:eC}=ef.default,eZ=(0,n.createContext)({history:[],replyLoading:!1,scrollRef:{current:null},canAbort:!1,chartsData:[],agent:"",currentDialogue:{},appInfo:{},temperatureValue:.5,maxNewTokensValue:1024,resourceValue:{},modelValue:"",excelPreviewData:void 0,excelPreviewVisible:!1,setExcelPreviewData:()=>{},setExcelPreviewVisible:()=>{},setModelValue:()=>{},setResourceValue:()=>{},setTemperatureValue:()=>{},setMaxNewTokensValue:()=>{},setAppInfo:()=>{},setAgent:()=>{},setCanAbort:()=>{},setReplyLoading:()=>{},refreshDialogList:()=>{},refreshHistory:()=>{},refreshAppInfo:()=>{},setHistory:()=>{},handleChat:()=>Promise.resolve()});var eE=()=>{var e,t,l,i;let c=(0,T.useRouter)(),{model:o,currentDialogInfo:d,setCurrentDialogInfo:x}=(0,n.useContext)(r.p),{isContract:m,setIsContract:h,setIsMenuExpand:f}=(0,n.useContext)(r.p),{chat:p,ctrl:g}=(0,w.Z)({app_code:d.app_code||""}),b=(0,q.useSearchParams)(),v=null!==(e=null==b?void 0:b.get("id"))&&void 0!==e?e:"",_=null!==(t=null==b?void 0:b.get("scene"))&&void 0!==t?t:"",j=null!==(l=null==b?void 0:b.get("knowledge_id"))&&void 0!==l?l:"",S=null!==(i=null==b?void 0:b.get("db_name"))&&void 0!==i?i:"",C=(0,n.useRef)(null),Z=(0,n.useRef)(1),E=(0,n.useRef)(null),M=(0,n.useRef)(void 0),R=(0,n.useRef)(!1),[O,L]=(0,n.useState)([]),[P]=(0,n.useState)(),[z,D]=(0,n.useState)(!1),[I,A]=(0,n.useState)(!1),[F,H]=(0,n.useState)(""),[J,G]=(0,n.useState)({}),[W,$]=(0,n.useState)(),[U,K]=(0,n.useState)(),[B,Q]=(0,n.useState)(),[Y,X]=(0,n.useState)(""),[ee,et]=(0,n.useState)(),[er,es]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=async()=>{if(!v&&!_&&!R.current){R.current=!0;let[,e]=await (0,s.Vx)((0,s.sW)({chat_mode:"chat_excel",model:o}));e&&(null==x||x({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),c.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(o?"&model=".concat(o):""))),R.current=!1}};e()},[v,_,o,c,x]),(0,n.useEffect)(()=>{var e,t,l,a,r,s,n,i;$((null===(e=null==J?void 0:null===(t=J.param_need)||void 0===t?void 0:t.filter(e=>"temperature"===e.type)[0])||void 0===e?void 0:e.value)||.6),K((null===(l=null==J?void 0:null===(a=J.param_need)||void 0===a?void 0:a.filter(e=>"max_new_tokens"===e.type)[0])||void 0===l?void 0:l.value)||4e3),X((null===(r=null==J?void 0:null===(s=J.param_need)||void 0===s?void 0:s.filter(e=>"model"===e.type)[0])||void 0===r?void 0:r.value)||o),Q(j||S||(null===(n=null==J?void 0:null===(i=J.param_need)||void 0===i?void 0:i.filter(e=>"resource"===e.type)[0])||void 0===n?void 0:n.bind_value))},[J,S,j,o]),(0,n.useEffect)(()=>{v&&(L([]),Z.current=1,Q(null),et(void 0),es(!1))},[v,Q,L,et]),(0,n.useEffect)(()=>{f("chat_dashboard"!==_),v&&_&&h(!1)},[v,_,h,f]);let en=(0,n.useMemo)(()=>!v&&!_,[v,_]),{data:ei=[],refresh:eo,loading:ed}=(0,el.Z)(async()=>await (0,s.Vx)((0,s.iP)())),{run:eu,refresh:ex}=(0,el.Z)(async()=>await (0,s.Vx)((0,s.BN)({...d})),{manual:!0,onSuccess:e=>{let[,t]=e;G(t||{})}}),em=(0,n.useMemo)(()=>{let[,e]=ei;return(null==e?void 0:e.find(e=>e.conv_uid===v))||{}},[v,ei]);(0,n.useEffect)(()=>{if((null==em?void 0:em.select_param)&&(null==em?void 0:em.conv_uid)===v&&"chat_excel"===_&&!B){console.log("\uD83D\uDD04 开始恢复历史会话数据...");try{let t="string"==typeof em.select_param?JSON.parse(em.select_param):em.select_param;if(console.log("\uD83D\uDCE6 select_param:",t),t&&Object.keys(t).length>0&&(console.log("✅ 恢复 resourceValue"),Q(t)),null==t?void 0:t.preview_data){var e;console.log("✅ 恢复 excelPreviewData，数据行数:",null===(e=t.preview_data.rows)||void 0===e?void 0:e.length);let l={...t.preview_data,file_name:t.file_name||t.original_filename};et(l)}else console.log("⚠️ select_param 中没有 preview_data")}catch(e){console.error("❌ 恢复数据失败:",e)}}},[null==em?void 0:em.select_param,null==em?void 0:em.conv_uid,v,_,B,Q,et]),(0,n.useEffect)(()=>{let e=(0,k.a_)();d.chat_scene!==_||en||e&&e.message||eu()},[v,d,en,eu,_]);let{run:eh,loading:eg,refresh:eb}=(0,el.Z)(async()=>await (0,s.Vx)((0,s.$i)(v)),{manual:!0,onSuccess:e=>{let[,t]=e,l=null==t?void 0:t.filter(e=>"view"===e.role);l&&l.length>0&&(Z.current=l[l.length-1].order+1),L(t||[])}}),ev=(0,n.useCallback)((e,t)=>new Promise(l=>{let a=(0,k.a_)(),r=new AbortController;if(D(!0),O&&O.length>0){var s,n;let e=null==O?void 0:O.filter(e=>"view"===e.role),t=null==O?void 0:O.filter(e=>"human"===e.role);Z.current=((null===(s=e[e.length-1])||void 0===s?void 0:s.order)||(null===(n=t[t.length-1])||void 0===n?void 0:n.order))+1}let i="";if("string"==typeof e)i=e;else{let t=e.content||[],l=t.filter(e=>"text"===e.type),a=t.filter(e=>"text"!==e.type);l.length>0&&(i=l.map(e=>e.text).join(" "));let r=a.map(e=>{if("image_url"===e.type){var t,l;let a=(null===(t=e.image_url)||void 0===t?void 0:t.url)||"",r=(0,k.Hb)(a),s=(null===(l=e.image_url)||void 0===l?void 0:l.fileName)||"image";return"\n![".concat(s,"](").concat(r,")")}if("video"!==e.type)return"";{let t=e.video||"",l=(0,k.Hb)(t);return"\n[Video](".concat(l,")")}}).filter(e=>""!==e).join("\n");r&&(i=i+"\n"+r)}let c=[...a&&a.id===v?[]:O,{role:"human",context:i,model_name:(null==t?void 0:t.model_name)||Y,order:Z.current,time_stamp:0},{role:"view",context:"",model_name:(null==t?void 0:t.model_name)||Y,order:Z.current,time_stamp:0,thinking:!0}],o=c.length-1;L([...c]);let d={chat_mode:_,model_name:Y,user_input:e};if(t&&Object.assign(d,t),"chat_dashboard"!==_){let e=M.current||localStorage.getItem("dbgpt_prompt_code_".concat(v));e&&(d.prompt_code=e,localStorage.removeItem("dbgpt_prompt_code_".concat(v)))}p({data:d,ctrl:r,chatId:v,onMessage:e=>{A(!0),(null==t?void 0:t.incremental)?(c[o].context+=e,c[o].thinking=!1):(c[o].context=e,c[o].thinking=!1),L([...c])},onDone:()=>{D(!1),A(!1),l()},onClose:()=>{D(!1),A(!1),l()},onError:e=>{D(!1),A(!1),c[o].context=e,c[o].thinking=!1,L([...c]),l()}})}),[v,O,Y,p,_]);return(0,ea.Z)(async()=>{if(en)return;let e=(0,k.a_)();e&&e.id===v||await eh()},[v,_,eh]),(0,n.useEffect)(()=>{en&&(Z.current=1,L([]))},[en]),(0,a.jsx)(eZ.Provider,{value:{history:O,replyLoading:z,scrollRef:C,canAbort:I,chartsData:P||[],agent:F,currentDialogue:em,appInfo:J,temperatureValue:W,maxNewTokensValue:U,resourceValue:B,modelValue:Y,excelPreviewData:ee,excelPreviewVisible:er,setExcelPreviewData:et,setExcelPreviewVisible:es,setModelValue:X,setResourceValue:Q,setTemperatureValue:$,setMaxNewTokensValue:K,setAppInfo:G,setAgent:H,setCanAbort:A,setReplyLoading:D,handleChat:ev,refreshDialogList:eo,refreshHistory:eb,refreshAppInfo:ex,setHistory:L},children:(0,a.jsx)(ep.Z,{flex:1,children:(0,a.jsxs)(ef.default,{className:"bg-gradient-light bg-cover bg-center dark:bg-gradient-dark",children:[(0,a.jsx)(ew,{refresh:eo,dialogueList:ei,listLoading:ed,historyLoading:eg,order:Z}),(0,a.jsx)(ef.default,{className:"bg-transparent",children:"chat_dashboard"===_?m?(0,a.jsx)(ek,{}):(0,a.jsx)(eS,{}):"chat_excel"===_?en?(0,a.jsx)(eC,{className:"flex items-center justify-center h-full",children:(0,a.jsx)(u.Z,{size:"large"})}):(0,a.jsx)(u.Z,{spinning:eg,className:"w-full h-full m-auto",children:(0,a.jsx)(eC,{className:"h-screen",children:er&&ee?(0,a.jsx)(N,{leftPanel:(0,a.jsx)("div",{className:"h-full overflow-hidden",children:(0,a.jsx)(y,{})}),rightPanel:(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)(V,{ref:C,className:"flex-1"}),(0,a.jsx)(ec,{ref:E,ctrl:g})]}),defaultLeftWidth:60,minLeftWidth:30,maxLeftWidth:80}):(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)(V,{ref:C,className:"flex-1"}),(0,a.jsx)(ec,{ref:E,ctrl:g})]})})}):en?(0,a.jsx)(eC,{className:"flex items-center justify-center h-full",children:(0,a.jsx)(u.Z,{size:"large"})}):(0,a.jsx)(u.Z,{spinning:eg,className:"w-full h-full m-auto",children:(0,a.jsxs)(eC,{className:"flex flex-col h-screen",children:[(0,a.jsx)(V,{ref:C,className:"flex-1"}),(0,a.jsx)(ec,{ref:E,ctrl:g})]})})})]})})})}}}]);