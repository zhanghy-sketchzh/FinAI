"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9834],{23430:function(e,t,l){var r=l(85893),a=l(25675),n=l.n(a);t.Z=function(e){let{src:t,label:l,width:a,height:s,className:c}=e;return(0,r.jsx)(n(),{className:"w-11 h-11 rounded-full mr-4 border border-gray-200 object-contain bg-white ".concat(c),width:a||44,height:s||44,src:t,alt:l||"db-icon"})}},43446:function(e,t,l){var r=l(41468),a=l(64371),n=l(62418),s=l(25519),c=l(1375),i=l(45360),o=l(67294);t.Z=e=>{let{queryAgentURL:t="/api/v1/chat/completions",app_code:l}=e,[d,u]=(0,o.useState)({}),{scene:m}=(0,o.useContext)(r.p),h=(0,o.useCallback)(async e=>{let{data:r,chatId:o,onMessage:d,onClose:h,onDone:x,onError:p,ctrl:f}=e;if(f&&u(f),!(null==r?void 0:r.user_input)&&!(null==r?void 0:r.doc_id)){i.ZP.warning(a.Z.t("no_context_tip"));return}let g={conv_uid:o,app_code:l};r&&Object.keys(r).forEach(e=>{g[e]=r[e]});try{var v,_;await (0,c.L)("".concat((v="http://localhost:5670",void 0!==v)?v:"").concat(t),{method:"POST",headers:{"Content-Type":"application/json",[s.gp]:null!==(_=(0,n.n5)())&&void 0!==_?_:""},body:JSON.stringify(g),signal:f?f.signal:null,openWhenHidden:!0,async onopen(e){e.ok&&e.headers.get("content-type")===c.a||"application/json"!==e.headers.get("content-type")||e.json().then(e=>{null==d||d(e),null==x||x(),f&&f.abort()})},onclose(){f&&f.abort(),null==h||h()},onerror(e){throw Error(e)},onmessage:e=>{let t=e.data;try{if("chat_agent"===m)t=JSON.parse(t).vis;else{var l,a,n;r=JSON.parse(e.data),t=null===(l=r.choices)||void 0===l?void 0:null===(a=l[0])||void 0===a?void 0:null===(n=a.message)||void 0===n?void 0:n.content}}catch(e){t.replaceAll("\\n","\n")}"string"==typeof t?"[DONE]"===t?null==x||x():(null==t?void 0:t.startsWith("[ERROR]"))?null==p||p(null==t?void 0:t.replace("[ERROR]","")):null==d||d(t):(null==d||d(t),null==x||x())}})}catch(e){f&&f.abort(),null==p||p("Sorry, We meet some error, please try agin later.",e)}},[t,l,m]);return{chat:h,ctrl:d}}},48218:function(e,t,l){var r=l(85893),a=l(82353),n=l(16165),s=l(67294);t.Z=e=>{let{width:t,height:l,scene:c}=e,i=(0,s.useCallback)(()=>{switch(c){case"chat_knowledge":return a.je;case"chat_with_db_execute":return a.zM;case"chat_excel":return a.DL;case"chat_with_db_qa":case"chat_dba":return a.RD;case"chat_dashboard":return a.In;case"chat_agent":return a.si;case"chat_normal":return a.O7;default:return}},[c]);return(0,r.jsx)(n.Z,{className:"w-".concat(t||7," h-").concat(l||7),component:i()})}},19834:function(e,t,l){l.r(t),l.d(t,{ChatContentContext:function(){return eN},default:function(){return ek}});var r=l(85893),a=l(41468),n=l(80169),s=l(43446),c=l(62418),i=l(24969),o=l(50888),d=l(90598),u=l(75750),m=l(45030),h=l(74330),x=l(66309),p=l(11163),f=l(67294),g=l(67421),v=l(65654),_=l(48218);let b=["magenta","orange","geekblue","purple","cyan","green"];var j=e=>{var t,l;let{isScrollToTop:s}=e,{appInfo:j,refreshAppInfo:y,handleChat:w,scrollRef:N,temperatureValue:k,resourceValue:S,currentDialogue:Z,refreshDialogList:C,setResourceValue:T,setHistory:E}=(0,f.useContext)(eN),{model:R,setCurrentDialogInfo:M}=(0,f.useContext)(a.p),O=(0,p.useRouter)(),{t:L}=(0,g.$G)(),I=(0,f.useCallback)(async()=>{null==T||T(null),null==E||E([]),localStorage.removeItem(c.rU);let[,e]=await (0,n.Vx)((0,n.sW)({chat_mode:"chat_excel",model:R}));e&&(null==M||M({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),O.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(R?"&model=".concat(R):"")),null==C||C())},[R,O,M,C,T,E]),z=(0,f.useMemo)(()=>{var e;return(null==j?void 0:null===(e=j.team_context)||void 0===e?void 0:e.chat_scene)||"chat_agent"},[j]),V=(0,f.useMemo)(()=>"chat_excel"===z?L("chat_excel_app_name"):null==j?void 0:j.app_name,[z,null==j?void 0:j.app_name,L]),A=(0,f.useMemo)(()=>"chat_excel"===z?L("chat_excel_app_describe"):null==j?void 0:j.app_describe,[z,null==j?void 0:j.app_describe,L]),P=(0,f.useMemo)(()=>(null==j?void 0:j.is_collected)==="true",[j]),{run:D,loading:F}=(0,v.Z)(async()=>{let[e]=await (0,n.Vx)(P?(0,n.gD)({app_code:j.app_code}):(0,n.mo)({app_code:j.app_code}));if(!e)return await y()},{manual:!0}),H=(0,f.useMemo)(()=>{var e;return(null===(e=j.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[j.param_need]);return Object.keys(j).length?(0,r.jsx)("div",{className:"h-20 mt-6 ".concat((null==j?void 0:j.recommend_questions)&&(null==j?void 0:null===(t=j.recommend_questions)||void 0===t?void 0:t.length)>0?"mb-6":""," sticky top-0 bg-transparent z-30 transition-all duration-400 ease-in-out"),children:s?(0,r.jsxs)("header",{className:"flex items-center justify-between w-full h-14 bg-[#f0f7ff] dark:bg-[#1a2332] px-8 transition-all duration-500 ease-in-out",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg mr-2 bg-white",children:(0,r.jsx)(_.Z,{scene:z})}),(0,r.jsx)("div",{className:"flex items-center text-base text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] font-semibold gap-2",children:(0,r.jsx)("span",{children:V})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("div",{onClick:I,className:"flex items-center gap-1.5 px-3 h-8 rounded-full cursor-pointer hover:bg-[#f0f0f0] dark:hover:bg-[rgba(255,255,255,0.2)]",children:[(0,r.jsx)(i.Z,{style:{fontSize:14}}),(0,r.jsx)("span",{className:"text-sm font-medium",children:L("new_chat")})]}),(0,r.jsx)("div",{onClick:async()=>{await D()},className:"cursor-pointer",children:F?(0,r.jsx)(h.Z,{spinning:F,indicator:(0,r.jsx)(o.Z,{style:{fontSize:24},spin:!0})}):(0,r.jsx)(r.Fragment,{children:P?(0,r.jsx)(d.Z,{style:{fontSize:18},className:"text-yellow-400 cursor-pointer"}):(0,r.jsx)(u.Z,{style:{fontSize:18,cursor:"pointer"}})})})]})]}):(0,r.jsxs)("header",{className:"flex items-center justify-between w-5/6 h-full px-6  bg-[#ffffff99] border dark:bg-[rgba(255,255,255,0.1)] dark:border-[rgba(255,255,255,0.1)] rounded-2xl mx-auto transition-all duration-400 ease-in-out relative",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"flex w-12 h-12 justify-center items-center rounded-xl mr-4 bg-white",children:(0,r.jsx)(_.Z,{scene:z,width:16,height:16})}),(0,r.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,r.jsx)("div",{className:"flex items-center text-base text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] font-semibold gap-2",children:(0,r.jsx)("span",{children:V})}),(0,r.jsx)(m.default.Text,{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] leading-6",ellipsis:{tooltip:!0},children:A})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("div",{onClick:I,className:"flex items-center gap-2 px-4 h-10 bg-[#ffffff99] dark:bg-[rgba(255,255,255,0.2)] border border-white dark:border-[rgba(255,255,255,0.2)] rounded-full cursor-pointer hover:bg-[#f0f0f0] dark:hover:bg-[rgba(255,255,255,0.3)]",children:[(0,r.jsx)(i.Z,{style:{fontSize:16}}),(0,r.jsx)("span",{className:"text-sm font-medium",children:L("new_chat")})]}),(0,r.jsx)("div",{onClick:async()=>{await D()},className:"flex items-center justify-center w-10 h-10 bg-[#ffffff99] dark:bg-[rgba(255,255,255,0.2)] border border-white dark:border-[rgba(255,255,255,0.2)] rounded-[50%] cursor-pointer",children:F?(0,r.jsx)(h.Z,{spinning:F,indicator:(0,r.jsx)(o.Z,{style:{fontSize:24},spin:!0})}):(0,r.jsx)(r.Fragment,{children:P?(0,r.jsx)(d.Z,{style:{fontSize:18},className:"text-yellow-400 cursor-pointer"}):(0,r.jsx)(u.Z,{style:{fontSize:18,cursor:"pointer"}})})})]}),!!(null==j?void 0:null===(l=j.recommend_questions)||void 0===l?void 0:l.length)&&(0,r.jsxs)("div",{className:"absolute  bottom-[-40px] left-0",children:[(0,r.jsx)("span",{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] leading-6",children:L("maybe_you_want_to_ask")}),j.recommend_questions.map((e,t)=>(0,r.jsx)(x.Z,{color:b[t],className:"text-xs p-1 px-2 cursor-pointer",onClick:async()=>{w((null==e?void 0:e.question)||"",{app_code:j.app_code,...H.includes("temperature")&&{temperature:k},...H.includes("resource")&&{select_param:"string"==typeof S?S:JSON.stringify(S)||Z.select_param}}),setTimeout(()=>{var e,t;null===(e=N.current)||void 0===e||e.scrollTo({top:null===(t=N.current)||void 0===t?void 0:t.scrollHeight,behavior:"smooth"})},0)},children:e.question},e.id))]})]})}):null},y=l(62635),w=l(66017),N=l(5152),k=l.n(N);let S=k()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(1265),l.e(8791),l.e(5418),l.e(4567),l.e(2398),l.e(1300),l.e(2086),l.e(4309),l.e(4347),l.e(7562),l.e(3028),l.e(9720),l.e(8677),l.e(3783),l.e(9202),l.e(5265),l.e(5533),l.e(3764),l.e(188),l.e(9533),l.e(3768),l.e(5789),l.e(4275)]).then(l.bind(l,88331)),{loadableGenerated:{webpack:()=>[88331]},ssr:!1});var Z=(0,f.forwardRef)((e,t)=>{let{className:l}=e,a=(0,f.useRef)(null),[n,s]=(0,f.useState)(!1),[c,i]=(0,f.useState)(!1),[o,d]=(0,f.useState)(!0),[u,m]=(0,f.useState)(!1),{history:h}=(0,f.useContext)(eN),x=(0,f.useRef)(!0),p=(0,f.useRef)(null),g=(0,f.useRef)(null),v=(0,f.useRef)(0);(0,f.useImperativeHandle)(t,()=>a.current);let _=(0,f.useCallback)(()=>{var e;if(!a.current)return;let t=a.current,l=t.scrollTop,r=t.scrollHeight,n=t.clientHeight,c=Number(null==t?void 0:null===(e=t.dataset)||void 0===e?void 0:e.lastScrollTop)||0,o=l>c?"down":"up";t.dataset.lastScrollTop=String(l);let u=l+n>=r-40;x.current="down"===o||u,d(l<=20),m(l+n>=r-20),l>=74?s(!0):s(!1);let h=r>n;i(h)},[]);(0,f.useEffect)(()=>{let e=a.current;if(e){e.addEventListener("scroll",_);let t=e.scrollHeight>e.clientHeight;i(t)}return()=>{e&&e.removeEventListener("scroll",_)}},[_]);let b=(0,f.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!a.current||!e&&!x.current)return;let t=a.current,{scrollTop:l,scrollHeight:r,clientHeight:n}=t;if(!(l+n>=r-Math.max(50,.1*n))&&!e)return;g.current&&(clearTimeout(g.current),g.current=null),p.current&&cancelAnimationFrame(p.current);let s=()=>{if(a.current){let t=a.current.scrollHeight;a.current.scrollTo({top:t,behavior:e?"smooth":"auto"}),a.current.scrollTop<t-10&&(a.current.scrollTop=t),v.current=t}};p.current=requestAnimationFrame(()=>{s(),g.current=setTimeout(()=>{s(),setTimeout(()=>{if(a.current){let e=a.current.scrollHeight;e!==v.current&&s()}},100),g.current=null},50),p.current=null})},[]),N=(0,f.useMemo)(()=>{let e=h[h.length-1];return e?{context:e.context,thinking:e.thinking,role:e.role}:null},[h]),k=(0,f.useRef)(h.length),Z=(0,f.useRef)("");(0,f.useEffect)(()=>{let e=h.length,t=e>k.current,l=N?"".concat(N.role,"-").concat(N.context,"-").concat(N.thinking):"",r=l!==Z.current;t?(x.current=!0,k.current=e,Z.current=l,setTimeout(()=>{b(!0)},0),setTimeout(()=>{b(!0)},100),setTimeout(()=>{b(!0)},300)):r&&(Z.current=l,setTimeout(()=>{b(!1)},0),setTimeout(()=>{b(!1)},100))},[h.length,null==N?void 0:N.context,null==N?void 0:N.thinking,null==N?void 0:N.role,b]),(0,f.useEffect)(()=>{if(!a.current)return;let e=a.current,t=null,l=()=>{if(!e)return;let l=e.scrollHeight,r=l!==v.current;r&&(v.current=l,x.current&&(t=setTimeout(()=>{e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},50),requestAnimationFrame(()=>{e&&e.scrollTo({top:e.scrollHeight,behavior:"auto"})})))},r=new ResizeObserver(()=>{l()}),n=new MutationObserver(()=>{l()});r.observe(e),n.observe(e,{childList:!0,subtree:!0,characterData:!0});let s=setInterval(()=>{l()},200);return()=>{r.disconnect(),n.disconnect(),clearInterval(s),t&&clearTimeout(t)}},[]),(0,f.useEffect)(()=>()=>{p.current&&cancelAnimationFrame(p.current),g.current&&clearTimeout(g.current)},[]);let C=(0,f.useCallback)(()=>{a.current&&a.current.scrollTo({top:0,behavior:"smooth"})},[]),T=(0,f.useCallback)(()=>{a.current&&a.current.scrollTo({top:a.current.scrollHeight,behavior:"smooth"})},[]);return(0,r.jsxs)("div",{className:"flex flex-1 overflow-hidden relative ".concat(l||""),children:[(0,r.jsxs)("div",{ref:a,className:"h-full w-full mx-auto overflow-y-auto",children:[(0,r.jsx)(j,{isScrollToTop:n}),(0,r.jsx)(S,{})]}),c&&(0,r.jsxs)("div",{className:"absolute right-4 md:right-6 bottom-[120px] md:bottom-[100px] flex flex-col gap-2 z-[999]",children:[!o&&(0,r.jsx)("button",{onClick:C,className:"w-9 h-9 md:w-10 md:h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-200","aria-label":"Scroll to top",children:(0,r.jsx)(y.Z,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)] text-sm md:text-base"})}),!u&&(0,r.jsx)("button",{onClick:T,className:"w-9 h-9 md:w-10 md:h-10 bg-white dark:bg-[rgba(255,255,255,0.2)] border border-gray-200 dark:border-[rgba(255,255,255,0.2)] rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-200","aria-label":"Scroll to bottom",children:(0,r.jsx)(w.Z,{className:"text-[#525964] dark:text-[rgba(255,255,255,0.85)] text-sm md:text-base"})})]})]})}),C=l(80882),T=l(48115),E=l(25278),R=l(14726),M=l(93967),O=l.n(M),L=l(39332),I=l(30159),z=l(48689),V=l(52645),A=l(85576),P=l(45360),D=l(83062),F=l(25675),H=l.n(F),G=l(42952),J=l(34041),q=l(39718);let U=e=>{if(!e)return e;let t=e.includes("/")&&e.split("/").pop()||e;if(t.includes(":")){let[e,l]=t.split(":"),r=e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("-");return"".concat(r,"-").concat(l.toUpperCase())}["Instruct","Chat","Base","Distill","Qwen","Llama"].forEach(e=>{let l=RegExp("-".concat(e,"$"),"i");t=t.replace(l,"");let r=RegExp("-Distill-(?:Qwen|Llama)","i");t=t.replace(r,"")});let l=t.match(/(\d+[BbMm])/);if(l){let e=l[1].toUpperCase();t=(t=t.replace(/[-_]?\d+[BbMm][-_]?/g,"-").replace(/-+/g,"-").replace(/-$/,"")).replace(/-A\d+B/i,""),t="".concat(t,"-").concat(e)}return t=t.replace(/-+/g,"-").replace(/^-|-$/g,"")};var $=(0,f.memo)(()=>{let{modelList:e}=(0,f.useContext)(a.p),{appInfo:t,modelValue:l,setModelValue:n}=(0,f.useContext)(eN),{t:s}=(0,g.$G)(),c=(0,f.useMemo)(()=>{var e;return(null===(e=t.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[t.param_need]);return c.includes("model")?(0,r.jsx)(J.default,{value:l,placeholder:s("choose_model"),className:"h-8 rounded-3xl",onChange:e=>{n(e)},popupMatchSelectWidth:280,optionLabelProp:"label",children:e.map(e=>(0,r.jsx)(J.default.Option,{value:e,label:U(e),children:(0,r.jsx)(D.Z,{title:e,placement:"right",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(q.Z,{model:e}),(0,r.jsx)("span",{className:"ml-2",children:U(e)})]})})},e))}):(0,r.jsx)(D.Z,{title:s("model_tip"),children:(0,r.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)]",children:(0,r.jsx)(G.Z,{className:"text-xl cursor-not-allowed opacity-30"})})})}),W=l(23430),B=l(90725),Q=l(83266),Y=l(2093),K=l(23799),X=(0,f.memo)(e=>{var t,l,a,s;let{fileList:i,setFileList:o,setLoading:d,fileName:u}=e,{setResourceValue:m,appInfo:h,refreshHistory:x,refreshDialogList:p,modelValue:_,resourceValue:b}=(0,f.useContext)(eN),{temperatureValue:j,maxNewTokensValue:y}=(0,f.useContext)(eN),w=(0,L.useSearchParams)(),N=null!==(t=null==w?void 0:w.get("scene"))&&void 0!==t?t:"",k=null!==(l=null==w?void 0:w.get("id"))&&void 0!==l?l:"",{t:S}=(0,g.$G)(),[Z,C]=(0,f.useState)([]),T=(0,f.useMemo)(()=>{var e;return(null===(e=h.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[h.param_need]),E=(0,f.useMemo)(()=>{var e,t;return T.includes("resource")&&(null===(e=null===(t=h.param_need)||void 0===t?void 0:t.filter(e=>"resource"===e.type)[0])||void 0===e?void 0:e.value)==="database"},[h.param_need,T]),R=(0,f.useMemo)(()=>{var e,t;return T.includes("resource")&&(null===(e=null===(t=h.param_need)||void 0===t?void 0:t.filter(e=>"resource"===e.type)[0])||void 0===e?void 0:e.value)==="knowledge"},[h.param_need,T]),M=(0,f.useMemo)(()=>{var e;return null===(e=h.param_need)||void 0===e?void 0:e.find(e=>"resource"===e.type)},[h.param_need]),{run:I,loading:z}=(0,v.Z)(async()=>await (0,n.Vx)((0,n.vD)(N)),{manual:!0,onSuccess:e=>{let[,t]=e;C(null!=t?t:[])}});(0,Y.Z)(async()=>{(E||R)&&!(null==M?void 0:M.bind_value)&&await I()},[E,R,M]);let V=(0,f.useMemo)(()=>{var e;return null===(e=Z.map)||void 0===e?void 0:e.call(Z,e=>({label:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(W.Z,{width:24,height:24,src:c.S$[e.type].icon,label:c.S$[e.type].label,className:"w-[1.5em] h-[1.5em] mr-1 inline-block mt-[-4px]"}),e.param]}),value:e.param}))},[Z]),A=(0,f.useCallback)(async()=>{let e=new FormData;e.append("doc_files",null==i?void 0:i[0]),d(!0);let[t,l]=await (0,n.Vx)((0,n.qn)({convUid:k,chatMode:N,data:e,model:_,temperatureValue:j,maxNewTokensValue:y,config:{timeout:36e5}})).finally(()=>{d(!1)});l&&(m(l),await x(),await p())},[k,i,_,p,x,N,d,m]);if(!T.includes("resource"))return(0,r.jsx)(D.Z,{title:S("extend_tip"),children:(0,r.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)]",children:(0,r.jsx)(B.Z,{className:"text-lg cursor-not-allowed opacity-30"})})});switch(null==M?void 0:M.value){case"excel_file":case"text_file":case"image_file":case"audio_file":case"video_file":{let e="chat_excel"===N&&(!!u||!!(null===(a=i[0])||void 0===a?void 0:a.name)),t=S("chat_excel"===N?"file_tip":"file_upload_tip");return(0,r.jsx)(K.default,{name:"file",accept:(()=>{switch(null==M?void 0:M.value){case"excel_file":return".csv,.xlsx,.xls";case"text_file":return".txt,.doc,.docx,.pdf,.md";case"image_file":return".jpg,.jpeg,.png,.gif,.bmp,.webp";case"audio_file":return".mp3,.wav,.ogg,.aac";case"video_file":return".mp4,.wav,.wav";default:return""}})(),fileList:i,showUploadList:!1,beforeUpload:(e,t)=>{null==o||o(t)},customRequest:A,disabled:e,children:(0,r.jsx)(D.Z,{title:t,arrow:!1,placement:"bottom",children:(0,r.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)]",children:(0,r.jsx)(Q.Z,{className:O()("text-xl",{"cursor-pointer":!e})})})})})}case"database":case"knowledge":case"plugin":case"awel_flow":return b||m(null==V?void 0:null===(s=V[0])||void 0===s?void 0:s.value),(0,r.jsx)(J.default,{value:b,className:"w-52 h-8 rounded-3xl",onChange:e=>{m(e)},disabled:!!(null==M?void 0:M.bind_value),loading:z,options:V})}}),ee=e=>{var t;let{ctrl:l,onLoadingChange:a}=e,{t:s}=(0,g.$G)(),i=(0,L.useSearchParams)(),d=null!==(t=null==i?void 0:i.get("id"))&&void 0!==t?t:"",{history:u,scrollRef:m,canAbort:x,replyLoading:p,currentDialogue:v,appInfo:_,temperatureValue:b,maxNewTokensValue:j,resourceValue:y,setTemperatureValue:w,setMaxNewTokensValue:N,refreshHistory:k,setCanAbort:S,setReplyLoading:Z,handleChat:C}=(0,f.useContext)(eN),[T,E]=(0,f.useState)([]),[R,M]=(0,f.useState)(!1),[F,G]=(0,f.useState)(!1),[J,q]=(0,f.useState)(!1);f.useEffect(()=>{null==a||a(R)},[R,a]);let U=(0,f.useMemo)(()=>{var e;return(null===(e=_.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[_.param_need]),W=(0,f.useMemo)(()=>[{tip:s("stop_replying"),icon:(0,r.jsx)(I.Z,{className:O()({"text-[#0c75fc]":x})}),can_use:x,key:"abort",onClick:()=>{x&&(l.abort(),setTimeout(()=>{S(!1),Z(!1)},100))}},{tip:s("clear_all_caches"),icon:J?(0,r.jsx)(h.Z,{spinning:J,indicator:(0,r.jsx)(o.Z,{style:{fontSize:20}})}):(0,r.jsx)(z.Z,{}),can_use:!p,key:"clear_all_caches",onClick:async()=>{J||A.default.confirm({title:s("confirm_clear_all_caches"),content:(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{children:s("clear_all_caches_content")}),(0,r.jsxs)("ul",{style:{paddingLeft:"20px",margin:"10px 0"},children:[(0,r.jsx)("li",{children:s("clear_cache_excel_db")}),(0,r.jsx)("li",{children:s("clear_cache_excel_files")}),(0,r.jsx)("li",{children:s("clear_cache_uploaded_excel")}),(0,r.jsx)("li",{children:s("clear_cache_excel_temp_db")}),(0,r.jsx)("li",{children:s("clear_cache_chat_history")}),(0,r.jsx)("li",{children:s("clear_cache_file_server")}),(0,r.jsx)("li",{children:s("clear_cache_model")})]}),(0,r.jsx)("p",{style:{color:"red",fontWeight:"bold"},children:s("clear_cache_warning")})]}),okText:s("confirm_clear"),cancelText:s("cancel"),okType:"danger",onOk:async()=>{q(!0);try{await (0,n.Vx)((0,n.YG)()),P.ZP.success(s("clear_cache_success")),setTimeout(()=>{window.location.reload()},3e3)}catch(e){P.ZP.error("".concat(s("clear_cache_failed"),": ").concat((null==e?void 0:e.message)||s("unknown_error")))}finally{q(!1)}}})}},{tip:s("erase_memory"),icon:F?(0,r.jsx)(h.Z,{spinning:F,indicator:(0,r.jsx)(o.Z,{style:{fontSize:20}})}):(0,r.jsx)(V.Z,{}),can_use:u.length>0,key:"clear",onClick:async()=>{F||(G(!0),await (0,n.Vx)((0,n.zR)(v.conv_uid)).finally(async()=>{await k(),G(!1)}))}}],[s,x,p,u,F,l,S,Z,C,_.app_code,U,b,y,v.select_param,v.conv_uid,m,k]),B=(0,f.useMemo)(()=>{try{if(y){if("string"==typeof y)return JSON.parse(y).file_name||"";return y.file_name||""}if((null==v?void 0:v.select_param)&&(null==v?void 0:v.conv_uid)===d)return JSON.parse(v.select_param).file_name||"";return""}catch(e){return""}},[y,null==v?void 0:v.select_param,null==v?void 0:v.conv_uid,d]);return(0,r.jsxs)("div",{className:"flex flex-col  mb-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between h-full w-full",children:[(0,r.jsxs)("div",{className:"flex gap-3 text-lg",children:[(0,r.jsx)($,{}),(0,r.jsx)(X,{fileList:T,setFileList:E,setLoading:M,fileName:B})]}),(0,r.jsx)("div",{className:"flex gap-1",children:(0,r.jsx)(r.Fragment,{children:W.map(e=>(0,r.jsx)(D.Z,{title:e.tip,arrow:!1,placement:"bottom",children:(0,r.jsx)("div",{className:"flex w-8 h-8 items-center justify-center rounded-md hover:bg-[rgb(221,221,221,0.6)] text-lg ".concat(e.can_use?"cursor-pointer":"opacity-30 cursor-not-allowed"),onClick:()=>{var t;null===(t=e.onClick)||void 0===t||t.call(e)},children:e.icon})},e.key))})})]}),(0,r.jsx)(()=>{let e=(null==v?void 0:v.select_param)&&(null==v?void 0:v.conv_uid)===d?v.select_param:null,t=(0,c.Ev)(y)||(0,c.Ev)(e)||[];return 0===t.length?null:(0,r.jsx)("div",{className:"group/item flex flex-wrap gap-2 mt-2",children:t.map((e,t)=>{var l,a;if("image_url"===e.type&&(null===(l=e.image_url)||void 0===l?void 0:l.url)){let l=e.image_url.fileName,a=(0,c.Hb)(e.image_url.url);return(0,r.jsxs)("div",{className:"flex flex-col border border-[#e3e4e6] dark:border-[rgba(255,255,255,0.6)] rounded-lg p-2",children:[(0,r.jsx)("div",{className:"w-32 h-32 mb-2 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded",children:(0,r.jsx)("img",{src:a,alt:l||"Preview",className:"max-w-full max-h-full object-contain"})}),(0,r.jsx)("div",{className:"flex items-center",children:(0,r.jsx)("span",{className:"text-sm text-[#1c2533] dark:text-white line-clamp-1",children:l})})]},"img-".concat(t))}if("file_url"===e.type&&(null===(a=e.file_url)||void 0===a?void 0:a.url)){let l=e.file_url.file_name;return(0,r.jsx)("div",{className:"flex items-center justify-between border border-[#e3e4e6] dark:border-[rgba(255,255,255,0.6)] rounded-lg p-2",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(H(),{src:"/icons/chat/excel.png",width:20,height:20,alt:"file-icon",className:"mr-2"}),(0,r.jsx)("span",{className:"text-sm text-[#1c2533] dark:text-white line-clamp-1",children:l})]})},"file-".concat(t))}return null})})},{}),R&&(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,r.jsx)(h.Z,{spinning:R,indicator:(0,r.jsx)(o.Z,{style:{fontSize:16},spin:!0})}),(0,r.jsx)("span",{className:"text-sm text-gray-500",children:s("parsing_data")})]})]})};let et=["geekblue","purple","cyan","green","orange"];var el=(0,f.forwardRef)((e,t)=>{var l,a,n;let{ctrl:s}=e,{t:i}=(0,g.$G)(),{replyLoading:d,handleChat:u,appInfo:m,currentDialogue:p,temperatureValue:v,maxNewTokensValue:_,resourceValue:b,setResourceValue:j,refreshDialogList:y,history:w}=(0,f.useContext)(eN),N=(0,L.useSearchParams)(),k=null!==(l=null==N?void 0:N.get("scene"))&&void 0!==l?l:"",S=null!==(a=null==N?void 0:N.get("select_param"))&&void 0!==a?a:"",Z=null!==(n=null==N?void 0:N.get("id"))&&void 0!==n?n:"",[M,I]=(0,f.useState)(""),[z,V]=(0,f.useState)(!1),[A,P]=(0,f.useState)(!1),[D,F]=(0,f.useState)(!1),[H,G]=(0,f.useState)([]),[J,q]=(0,f.useState)(!1),U=(0,f.useRef)(""),$=(0,f.useRef)(""),W=(0,f.useRef)(0),B=(0,f.useMemo)(()=>{var e;return(null===(e=m.param_need)||void 0===e?void 0:e.map(e=>e.type))||[]},[m.param_need]);(0,f.useEffect)(()=>{let e=(null==p?void 0:p.conv_uid)||"";e&&U.current&&e!==U.current?(G([]),U.current=e):!e&&U.current?(G([]),U.current=""):e&&!U.current&&(U.current=e)},[null==p?void 0:p.conv_uid]),(0,f.useEffect)(()=>{if("chat_excel"!==k||!w||0===w.length)return;let e=w.filter(e=>"view"===e.role&&e.context);if(0===e.length)return;let t=e.reduce((e,t)=>(t.order||0)>(e.order||0)?t:e);if(!t||!t.context)return;let l=t.context,r="string"==typeof l?l:JSON.stringify(l),a="".concat(t.order,"_").concat(r.slice(-500));if(a===$.current&&r.includes("<!--SUGGESTED_QUESTIONS:"))return;let n="<!--SUGGESTED_QUESTIONS:",s=r.indexOf(n);if(-1!==s){let e=s+n.length,t=r.substring(e),l=t.lastIndexOf("-->");if(l>0){let e=t.substring(0,l);try{let t=JSON.parse(e),l=t.suggested_questions||[];if(Array.isArray(l)&&l.length>0){G(l.slice(0,5)),$.current=a;return}}catch(t){let e=r.match(/<!--SUGGESTED_QUESTIONS:(\{[\s\S]*?\})-->/);if(e)try{let t=JSON.parse(e[1]),l=t.suggested_questions||[];if(Array.isArray(l)&&l.length>0){G(l.slice(0,5)),$.current=a;return}}catch(e){}}}}$.current=a},[w,k]);let Q=(0,f.useMemo)(()=>{if("chat_excel"!==k)return[];try{let e="";if(b?e="string"==typeof b?b:JSON.stringify(b):(null==p?void 0:p.select_param)&&(null==p?void 0:p.conv_uid)===Z&&(e=p.select_param),!e)return[];let t={};try{t="string"==typeof e?JSON.parse(e):e}catch(e){return[]}let l=t.data_schema_json;if(!l)return[];let r={};try{r="string"==typeof l?JSON.parse(l):l}catch(e){return[]}let a=r.suggested_questions||[];return Array.isArray(a)?a.slice(0,5):[]}catch(e){return[]}},[k,b,p,Z]),Y=(0,f.useMemo)(()=>H.length>0?H:Q,[H,Q]),K=async e=>{!e.trim()||d||D||await X(e)},X=async e=>{let t;W.current++;let l=e||M;I("");let r=(0,c.Ev)(b);if(r.length>0){"chat_excel"!==k&&j(null);let e=[...r];e.push({type:"text",text:l}),t={role:"user",content:e}}else t=l;let a={app_code:m.app_code||"",...B.includes("temperature")&&{temperature:v},...B.includes("max_new_tokens")&&{max_new_tokens:_},select_param:S,...B.includes("resource")&&{select_param:"string"==typeof b?b:JSON.stringify(b)||p.select_param}};await u(t,a),1===W.current&&await y()};return(0,f.useImperativeHandle)(t,()=>({setUserInput:I})),(0,r.jsxs)("div",{className:"flex flex-col w-5/6 mx-auto pt-4 pb-6 bg-transparent",children:[Y.length>0&&(0,r.jsxs)("div",{className:"mb-4 flex flex-col gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 cursor-pointer select-none hover:opacity-80 transition-opacity",onClick:()=>q(!J),children:[(0,r.jsx)("span",{className:"text-sm text-[#525964] dark:text-[rgba(255,255,255,0.65)] leading-6",children:i("maybe_you_want_to_ask")||"您可能想问："}),J?(0,r.jsx)(C.Z,{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)] transition-transform"}):(0,r.jsx)(T.Z,{className:"text-xs text-[#525964] dark:text-[rgba(255,255,255,0.65)] transition-transform"})]}),!J&&(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:Y.map((e,t)=>(0,r.jsx)(x.Z,{color:et[t%et.length],className:"text-xs px-3 py-1 cursor-pointer hover:opacity-80 transition-opacity rounded-full",onClick:()=>K(e),children:e},t))})]}),(0,r.jsxs)("div",{className:"flex flex-1 flex-col bg-white dark:bg-[rgba(255,255,255,0.16)] px-5 py-4 pt-2 rounded-xl relative border-t border-b border-l border-r dark:border-[rgba(255,255,255,0.6)] ".concat(z?"border-[#0c75fc]":""),id:"input-panel",children:[(0,r.jsx)(ee,{ctrl:s,onLoadingChange:F}),(0,r.jsx)(E.default.TextArea,{placeholder:i("input_tips"),className:"w-full h-20 resize-none border-0 p-0 focus:shadow-none dark:bg-transparent",value:M,onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&!A&&(e.preventDefault(),!M.trim()||d||D||X())},onChange:e=>{I(e.target.value)},onFocus:()=>{V(!0)},onBlur:()=>V(!1),onCompositionStart:()=>P(!0),onCompositionEnd:()=>P(!1)}),(0,r.jsx)(R.ZP,{type:"primary",className:O()("flex items-center justify-center w-14 h-8 rounded-lg text-sm absolute right-4 bottom-3 bg-button-gradient border-0",{"cursor-not-allowed":!M.trim()||D,"opacity-40":D}),disabled:D,onClick:()=>{!d&&M.trim()&&!D&&X()},children:d?(0,r.jsx)(h.Z,{spinning:d,indicator:(0,r.jsx)(o.Z,{className:"text-white"})}):i("sent")})]})]})}),er=l(82353),ea=l(64569),en=l(25519),es=l(14313),ec=l(94155),ei=l(16165),eo=l(10524),ed=l(21612),eu=l(86250),em=l(55241),eh=l(30381),ex=l.n(eh);l(83839);var ep=l(41664),ef=l.n(ep);let{Sider:eg}=ed.default,ev={display:"flex",alignItems:"center",justifyContent:"center",width:16,height:48,position:"absolute",top:"50%",transform:"translateY(-50%)",border:"1px solid #d6d8da",borderRadius:8,right:-8},e_=e=>{var t,l;let{item:s,refresh:c,historyLoading:i}=e,{t:o}=(0,g.$G)(),d=(0,L.useRouter)(),u=(0,L.useSearchParams)(),h=null!==(t=null==u?void 0:u.get("id"))&&void 0!==t?t:"",x=null!==(l=null==u?void 0:u.get("scene"))&&void 0!==l?l:"",{setCurrentDialogInfo:p}=(0,f.useContext)(a.p),v=(0,f.useMemo)(()=>s.default?s.default&&!h&&!x:s.conv_uid===h&&s.chat_mode===x,[h,x,s]),_=()=>{A.default.confirm({title:o("delete_chat"),content:o("delete_chat_confirm"),centered:!0,onOk:async()=>{let[e]=await (0,n.Vx)((0,n.MX)(s.conv_uid));e||(await (null==c?void 0:c()),s.conv_uid===h&&d.push("/chat"))}})};return(0,r.jsxs)(eu.Z,{align:"center",className:"group/item w-full h-12 p-3 rounded-lg  hover:bg-white dark:hover:bg-theme-dark cursor-pointer mb-2 relative ".concat(v?"bg-white dark:bg-theme-dark bg-opacity-100":""),onClick:()=>{i||(s.default||null==p||p({chat_scene:s.chat_mode,app_code:s.app_code}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:s.chat_mode,app_code:s.app_code})),d.push(s.default?"/chat":"?scene=".concat(s.chat_mode,"&id=").concat(s.conv_uid)))},children:[(0,r.jsx)(D.Z,{title:s.chat_mode,children:(0,r.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg mr-3 bg-white",children:s.icon})}),(0,r.jsx)("div",{className:"flex flex-1 line-clamp-1",children:(0,r.jsx)(m.default.Text,{ellipsis:{tooltip:!0},children:s.label})}),!s.default&&(0,r.jsx)("div",{className:"flex gap-1 ml-1",children:(0,r.jsx)("div",{className:"group-hover/item:opacity-100 cursor-pointer opacity-0",onClick:e=>{e.stopPropagation(),_()},children:(0,r.jsx)(z.Z,{style:{fontSize:16}})})}),(0,r.jsx)("div",{className:" w-1 rounded-sm bg-[#0c75fc] absolute top-1/2 left-0 -translate-y-1/2 transition-all duration-500 ease-in-out ".concat(v?"h-5":"w-0 h-0")})]})};var eb=e=>{var t;let{dialogueList:l=[],refresh:s,historyLoading:c,listLoading:o,order:d}=e,u=(0,L.useRouter)(),m=(0,L.useSearchParams)(),x=null!==(t=null==m?void 0:m.get("scene"))&&void 0!==t?t:"",{t:p,i18n:v}=(0,g.$G)(),{mode:b,setMode:j,model:y,setCurrentDialogInfo:w}=(0,f.useContext)(a.p),{setResourceValue:N,setHistory:k}=(0,f.useContext)(eN),[S,Z]=(0,f.useState)("chat_dashboard"===x),C=(0,f.useCallback)(async()=>{null==N||N(null),null==k||k([]),localStorage.removeItem(en.rU);let[,e]=await (0,n.Vx)((0,n.sW)({chat_mode:"chat_excel",model:y}));e&&(null==w||w({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),u.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(y?"&model=".concat(y):"")),null==s||s())},[y,u,w,s,N,k]),T=(0,f.useCallback)(()=>{let e="light"===b?"dark":"light";j(e),localStorage.setItem(en.he,e)},[b,j]),E=(0,f.useCallback)(()=>{let e="en"===v.language?"zh":"en";v.changeLanguage(e),"zh"===e&&ex().locale("zh-cn"),"en"===e&&ex().locale("en"),localStorage.setItem(en.Yl,e)},[v]),R=(0,f.useMemo)(()=>S?{...ev,right:-16,borderRadius:"0px 8px 8px 0",borderLeft:"1px solid #d5e5f6"}:{...ev,borderLeft:"1px solid #d6d8da"},[S]),M=(0,f.useMemo)(()=>{let e=l[1]||[];return(null==e?void 0:e.length)>0?e.map(e=>({...e,label:e.user_input||e.select_param,key:e.conv_uid,icon:(0,r.jsx)(_.Z,{scene:e.chat_mode}),default:!1})):[]},[l]);return(0,r.jsx)(eg,{className:"bg-[#ffffff80] border-r border-[#d5e5f6] dark:bg-[#ffffff29] dark:border-[#ffffff66]",theme:b,width:280,collapsible:!0,collapsed:S,collapsedWidth:0,trigger:S?(0,r.jsx)(es.Z,{className:"text-base"}):(0,r.jsx)(ec.Z,{className:"text-base"}),zeroWidthTriggerStyle:R,onCollapse:e=>Z(e),children:(0,r.jsxs)("div",{className:"flex flex-col h-full w-full bg-transparent",children:[(0,r.jsx)("div",{className:"px-4 pt-4 pb-4",children:(0,r.jsx)(ef(),{href:"/",className:"flex items-center justify-center",children:(0,r.jsx)(H(),{src:"/finai_logo.png",alt:"FinAI",width:180,height:45})})}),(0,r.jsx)("div",{className:"px-4 pt-2",children:(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("div",{className:"text-base font-semibold text-[#1c2533] dark:text-[rgba(255,255,255,0.85)] line-clamp-1",children:p("dialog_list")}),(0,r.jsx)(D.Z,{title:p("new_chat"),children:(0,r.jsx)("div",{onClick:C,className:"flex items-center justify-center w-7 h-7 rounded-md bg-[#0c75fc] hover:bg-[#0a5fd4] text-white cursor-pointer",children:(0,r.jsx)(i.Z,{style:{fontSize:14}})})})]})}),(0,r.jsx)(eu.Z,{flex:1,vertical:!0,className:"overflow-y-auto px-4",children:(0,r.jsx)(h.Z,{spinning:o,className:"mt-2",children:!!(null==M?void 0:M.length)&&M.map(e=>(0,r.jsx)(e_,{item:e,refresh:s,historyLoading:c,order:d},null==e?void 0:e.key))})}),(0,r.jsx)("div",{className:"px-4 py-3 border-t border-dashed border-gray-200 dark:border-gray-700",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)(ea.Z,{onlyAvatar:!0,align:"left"}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(em.Z,{content:p("Theme"),children:(0,r.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-md hover:bg-[#F1F5F9] dark:hover:bg-theme-dark cursor-pointer text-lg",onClick:T,children:"dark"===b?(0,r.jsx)(ei.Z,{component:er.FD}):(0,r.jsx)(ei.Z,{component:er.ol})})}),(0,r.jsx)(em.Z,{content:p("language"),children:(0,r.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-md hover:bg-[#F1F5F9] dark:hover:bg-theme-dark cursor-pointer text-lg",onClick:E,children:(0,r.jsx)(eo.Z,{})})})]})]})})]})})};let ej=k()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(8791),l.e(5418),l.e(4567),l.e(1300),l.e(4309),l.e(4347),l.e(7562),l.e(3028),l.e(3764),l.e(188),l.e(3768),l.e(1905)]).then(l.bind(l,47760)),{loadableGenerated:{webpack:()=>[47760]},ssr:!1}),ey=k()(()=>Promise.all([l.e(3662),l.e(7034),l.e(8674),l.e(930),l.e(3166),l.e(2837),l.e(2168),l.e(8163),l.e(7126),l.e(1265),l.e(8791),l.e(5418),l.e(4567),l.e(2398),l.e(1300),l.e(2086),l.e(4309),l.e(4347),l.e(7562),l.e(3028),l.e(9720),l.e(8677),l.e(3783),l.e(9202),l.e(5265),l.e(5533),l.e(3764),l.e(188),l.e(7258),l.e(3768),l.e(5789),l.e(4117)]).then(l.bind(l,8334)),{loadableGenerated:{webpack:()=>[8334]},ssr:!1}),{Content:ew}=ed.default,eN=(0,f.createContext)({history:[],replyLoading:!1,scrollRef:{current:null},canAbort:!1,chartsData:[],agent:"",currentDialogue:{},appInfo:{},temperatureValue:.5,maxNewTokensValue:1024,resourceValue:{},modelValue:"",setModelValue:()=>{},setResourceValue:()=>{},setTemperatureValue:()=>{},setMaxNewTokensValue:()=>{},setAppInfo:()=>{},setAgent:()=>{},setCanAbort:()=>{},setReplyLoading:()=>{},refreshDialogList:()=>{},refreshHistory:()=>{},refreshAppInfo:()=>{},setHistory:()=>{},handleChat:()=>Promise.resolve()});var ek=()=>{var e,t,l,i;let o=(0,p.useRouter)(),{model:d,currentDialogInfo:u,setCurrentDialogInfo:m}=(0,f.useContext)(a.p),{isContract:x,setIsContract:g,setIsMenuExpand:_}=(0,f.useContext)(a.p),{chat:b,ctrl:j}=(0,s.Z)({app_code:u.app_code||""}),y=(0,L.useSearchParams)(),w=null!==(e=null==y?void 0:y.get("id"))&&void 0!==e?e:"",N=null!==(t=null==y?void 0:y.get("scene"))&&void 0!==t?t:"",k=null!==(l=null==y?void 0:y.get("knowledge_id"))&&void 0!==l?l:"",S=null!==(i=null==y?void 0:y.get("db_name"))&&void 0!==i?i:"",C=(0,f.useRef)(null),T=(0,f.useRef)(1),E=(0,f.useRef)(null),R=(0,f.useRef)(void 0),M=(0,f.useRef)(!1),[O,I]=(0,f.useState)([]),[z]=(0,f.useState)(),[V,A]=(0,f.useState)(!1),[P,D]=(0,f.useState)(!1),[F,H]=(0,f.useState)(""),[G,J]=(0,f.useState)({}),[q,U]=(0,f.useState)(),[$,W]=(0,f.useState)(),[B,Q]=(0,f.useState)(),[K,X]=(0,f.useState)("");(0,f.useEffect)(()=>{let e=async()=>{if(!w&&!N&&!M.current){M.current=!0;let[,e]=await (0,n.Vx)((0,n.sW)({chat_mode:"chat_excel",model:d}));e&&(null==m||m({chat_scene:"chat_excel",app_code:""}),localStorage.setItem("cur_dialog_info",JSON.stringify({chat_scene:"chat_excel",app_code:""})),o.replace("/chat?scene=chat_excel&id=".concat(e.conv_uid).concat(d?"&model=".concat(d):""))),M.current=!1}};e()},[w,N,d,o,m]),(0,f.useEffect)(()=>{var e,t,l,r,a,n,s,c;U((null===(e=null==G?void 0:null===(t=G.param_need)||void 0===t?void 0:t.filter(e=>"temperature"===e.type)[0])||void 0===e?void 0:e.value)||.6),W((null===(l=null==G?void 0:null===(r=G.param_need)||void 0===r?void 0:r.filter(e=>"max_new_tokens"===e.type)[0])||void 0===l?void 0:l.value)||4e3),X((null===(a=null==G?void 0:null===(n=G.param_need)||void 0===n?void 0:n.filter(e=>"model"===e.type)[0])||void 0===a?void 0:a.value)||d),Q(k||S||(null===(s=null==G?void 0:null===(c=G.param_need)||void 0===c?void 0:c.filter(e=>"resource"===e.type)[0])||void 0===s?void 0:s.bind_value))},[G,S,k,d]),(0,f.useEffect)(()=>{w&&(Q(null),I([]),T.current=1)},[w,Q,I]),(0,f.useEffect)(()=>{_("chat_dashboard"!==N),w&&N&&g(!1)},[w,N,g,_]);let ee=(0,f.useMemo)(()=>!w&&!N,[w,N]),{data:et=[],refresh:er,loading:ea}=(0,v.Z)(async()=>await (0,n.Vx)((0,n.iP)())),{run:en,refresh:es}=(0,v.Z)(async()=>await (0,n.Vx)((0,n.BN)({...u})),{manual:!0,onSuccess:e=>{let[,t]=e;J(t||{})}}),ec=(0,f.useMemo)(()=>{let[,e]=et;return(null==e?void 0:e.find(e=>e.conv_uid===w))||{}},[w,et]);(0,f.useEffect)(()=>{let e=(0,c.a_)();u.chat_scene!==N||ee||e&&e.message||en()},[w,u,ee,en,N]);let{run:ei,loading:eo,refresh:em}=(0,v.Z)(async()=>await (0,n.Vx)((0,n.$i)(w)),{manual:!0,onSuccess:e=>{let[,t]=e,l=null==t?void 0:t.filter(e=>"view"===e.role);l&&l.length>0&&(T.current=l[l.length-1].order+1),I(t||[])}}),eh=(0,f.useCallback)((e,t)=>new Promise(l=>{let r=(0,c.a_)(),a=new AbortController;if(A(!0),O&&O.length>0){var n,s;let e=null==O?void 0:O.filter(e=>"view"===e.role),t=null==O?void 0:O.filter(e=>"human"===e.role);T.current=((null===(n=e[e.length-1])||void 0===n?void 0:n.order)||(null===(s=t[t.length-1])||void 0===s?void 0:s.order))+1}let i="";if("string"==typeof e)i=e;else{let t=e.content||[],l=t.filter(e=>"text"===e.type),r=t.filter(e=>"text"!==e.type);l.length>0&&(i=l.map(e=>e.text).join(" "));let a=r.map(e=>{if("image_url"===e.type){var t,l;let r=(null===(t=e.image_url)||void 0===t?void 0:t.url)||"",a=(0,c.Hb)(r),n=(null===(l=e.image_url)||void 0===l?void 0:l.fileName)||"image";return"\n![".concat(n,"](").concat(a,")")}if("video"!==e.type)return"";{let t=e.video||"",l=(0,c.Hb)(t);return"\n[Video](".concat(l,")")}}).filter(e=>""!==e).join("\n");a&&(i=i+"\n"+a)}let o=[...r&&r.id===w?[]:O,{role:"human",context:i,model_name:(null==t?void 0:t.model_name)||K,order:T.current,time_stamp:0},{role:"view",context:"",model_name:(null==t?void 0:t.model_name)||K,order:T.current,time_stamp:0,thinking:!0}],d=o.length-1;I([...o]);let u={chat_mode:N,model_name:K,user_input:e};if(t&&Object.assign(u,t),"chat_dashboard"!==N){let e=R.current||localStorage.getItem("dbgpt_prompt_code_".concat(w));e&&(u.prompt_code=e,localStorage.removeItem("dbgpt_prompt_code_".concat(w)))}b({data:u,ctrl:a,chatId:w,onMessage:e=>{D(!0),(null==t?void 0:t.incremental)?(o[d].context+=e,o[d].thinking=!1):(o[d].context=e,o[d].thinking=!1),I([...o])},onDone:()=>{A(!1),D(!1),l()},onClose:()=>{A(!1),D(!1),l()},onError:e=>{A(!1),D(!1),o[d].context=e,o[d].thinking=!1,I([...o]),l()}})}),[w,O,K,b,N]);return(0,Y.Z)(async()=>{if(ee)return;let e=(0,c.a_)();e&&e.id===w||await ei()},[w,N,ei]),(0,f.useEffect)(()=>{ee&&(T.current=1,I([]))},[ee]),(0,r.jsx)(eN.Provider,{value:{history:O,replyLoading:V,scrollRef:C,canAbort:P,chartsData:z||[],agent:F,currentDialogue:ec,appInfo:G,temperatureValue:q,maxNewTokensValue:$,resourceValue:B,modelValue:K,setModelValue:X,setResourceValue:Q,setTemperatureValue:U,setMaxNewTokensValue:W,setAppInfo:J,setAgent:H,setCanAbort:D,setReplyLoading:A,handleChat:eh,refreshDialogList:er,refreshHistory:em,refreshAppInfo:es,setHistory:I},children:(0,r.jsx)(eu.Z,{flex:1,children:(0,r.jsxs)(ed.default,{className:"bg-gradient-light bg-cover bg-center dark:bg-gradient-dark",children:[(0,r.jsx)(eb,{refresh:er,dialogueList:et,listLoading:ea,historyLoading:eo,order:T}),(0,r.jsx)(ed.default,{className:"bg-transparent",children:"chat_dashboard"===N?x?(0,r.jsx)(ej,{}):(0,r.jsx)(ey,{}):ee?(0,r.jsx)(ew,{className:"flex items-center justify-center h-full",children:(0,r.jsx)(h.Z,{size:"large"})}):(0,r.jsx)(h.Z,{spinning:eo,className:"w-full h-full m-auto",children:(0,r.jsxs)(ew,{className:"flex flex-col h-screen",children:[(0,r.jsx)(Z,{ref:C,className:"flex-1"}),(0,r.jsx)(el,{ref:E,ctrl:j})]})})})]})})})}}}]);