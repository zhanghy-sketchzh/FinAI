(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6660],{8334:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return ey}});var n=l(85893),r=l(41468),a=l(80169),s=l(43446),i=l(62418),o=l(2093),c=l(93967),u=l.n(c),d=l(39332),x=l(67294),m=l(13768),h=l(91085),f=l(45247),p=()=>{let{history:e,setHistory:t,chatId:l,model:n,docId:i}=(0,x.useContext)(r.p),{chat:o}=(0,s.Z)({queryAgentURL:"/knowledge/document/summary"}),c=(0,x.useCallback)(async e=>{let[,r]=await (0,a.Vx)((0,a.$i)(l)),s=[...r,{role:"human",context:"",model_name:n,order:0,time_stamp:0},{role:"view",context:"",model_name:n,order:0,time_stamp:0,retry:!0}],c=s.length-1;t([...s]),await o({data:{doc_id:e||i,model_name:n},chatId:l,onMessage:e=>{s[c].context=e,t([...s])}})},[e,n,i,l]);return c},g=l(87740),v=l(57132),j=l(66478),b=l(14553),w=l(45360),y=l(83062),_=l(85576),Z=l(20640),N=l.n(Z),C=l(96486),k=l(67421),S=l(27496),P=l(25278),E=l(14726),R=l(11163),D=l(82353),F=l(1051);function M(e){let{document:t}=e;switch(t.status){case"RUNNING":return(0,n.jsx)(D.Rp,{});case"FINISHED":default:return(0,n.jsx)(D.s2,{});case"FAILED":return(0,n.jsx)(F.Z,{})}}function O(e){let{documents:t,dbParam:l}=e,r=(0,R.useRouter)(),a=e=>{r.push("/knowledge/chunk/?spaceName=".concat(l,"&id=").concat(e))};return(null==t?void 0:t.length)?(0,n.jsx)("div",{className:"absolute flex overflow-scroll h-12 top-[-35px] w-full z-10",children:t.map(e=>{let t;switch(e.status){case"RUNNING":t="#2db7f5";break;case"FINISHED":default:t="#87d068";break;case"FAILED":t="#f50"}return(0,n.jsx)(y.Z,{title:e.result,children:(0,n.jsxs)(E.ZP,{style:{color:t},onClick:()=>{a(e.id)},className:"shrink flex items-center mr-3",children:[(0,n.jsx)(M,{document:e}),e.doc_name]})},e.id)})}):null}var I=l(5392),L=l(23799);function U(e){let{dbParam:t,setDocId:l}=(0,x.useContext)(r.p),{onUploadFinish:s,handleFinish:i}=e,o=p(),[c,u]=(0,x.useState)(!1),d=async e=>{u(!0);let n=new FormData;n.append("doc_name",e.file.name),n.append("doc_file",e.file),n.append("doc_type","DOCUMENT");let r=await (0,a.Vx)((0,a.iG)(t||"default",n));if(!r[1]){u(!1);return}l(r[1]),s(),u(!1),null==i||i(!0),await o(r[1]),null==i||i(!1)};return(0,n.jsx)(L.default,{customRequest:d,showUploadList:!1,maxCount:1,multiple:!1,className:"absolute z-10 top-2 left-2",accept:".pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.md",children:(0,n.jsx)(E.ZP,{loading:c,size:"small",shape:"circle",icon:(0,n.jsx)(I.Z,{})})})}var V=function(e){let{children:t,loading:l,onSubmit:s,handleFinish:i,placeholder:o,...c}=e,{dbParam:u,scene:d}=(0,x.useContext)(r.p),[m,h]=(0,x.useState)(""),f=(0,x.useMemo)(()=>"chat_knowledge"===d,[d]),[p,g]=(0,x.useState)([]),v=(0,x.useRef)(0);async function j(){if(!u)return null;let[e,t]=await (0,a.Vx)((0,a._Q)(u,{page:1,page_size:v.current}));g((null==t?void 0:t.data)||[])}(0,x.useEffect)(()=>{f&&j()},[u]);let b=async()=>{v.current+=1,await j()};return(0,n.jsxs)("div",{className:"flex-1 relative",children:[(0,n.jsx)(O,{documents:p,dbParam:u}),f&&(0,n.jsx)(U,{handleFinish:i,onUploadFinish:b,className:"absolute z-10 top-2 left-2"}),(0,n.jsx)(P.default.TextArea,{className:"flex-1 ".concat(f?"pl-10":""," pr-10"),size:"large",value:m,autoSize:{minRows:1,maxRows:4},...c,onPressEnter:e=>{if(m.trim()&&13===e.keyCode){if(e.shiftKey){e.preventDefault(),h(e=>e+"\n");return}s(m),setTimeout(()=>{h("")},0)}},onChange:e=>{if("number"==typeof c.maxLength){h(e.target.value.substring(0,c.maxLength));return}h(e.target.value)},placeholder:o}),(0,n.jsx)(E.ZP,{className:"ml-2 flex items-center justify-center absolute right-0 bottom-0",size:"large",type:"text",loading:l,icon:(0,n.jsx)(S.Z,{}),onClick:()=>{s(m)}}),t]})},$=l(32975),z=l(28516),A=(0,x.memo)(function(e){var t;let{content:l}=e,{scene:a}=(0,x.useContext)(r.p),s="view"===l.role;return(0,n.jsx)("div",{className:u()("relative w-full p-2 md:p-4 rounded-xl break-words",{"bg-white dark:bg-[#232734]":s,"lg:w-full xl:w-full pl-0":["chat_with_db_execute","chat_dashboard"].includes(a)}),children:s?(0,n.jsx)($.Z,{components:z.ZP,...z.dx,children:(0,z.CE)(null==(t=l.context)?void 0:t.replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>"))}):(0,n.jsx)("div",{className:"",children:l.context})})}),J=l(24019),T=l(50888),G=l(97937),H=l(63606),q=l(50228),B=l(87547),W=l(89035),Q=l(66309),K=l(81799);let X={todo:{bgClass:"bg-gray-500",icon:(0,n.jsx)(J.Z,{className:"ml-2"})},runing:{bgClass:"bg-blue-500",icon:(0,n.jsx)(T.Z,{className:"ml-2"})},failed:{bgClass:"bg-red-500",icon:(0,n.jsx)(G.Z,{className:"ml-2"})},completed:{bgClass:"bg-green-500",icon:(0,n.jsx)(H.Z,{className:"ml-2"})}};function Y(e){return e.replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>")}var ee=(0,x.memo)(function(e){let{children:t,content:l,isChartChat:a,onLinkClick:s}=e,{scene:i}=(0,x.useContext)(r.p),{context:o,model_name:c,role:d}=l,m="view"===d,{relations:h,value:f,cachePluginContext:p}=(0,x.useMemo)(()=>{if("string"!=typeof o)return{relations:[],value:"",cachePluginContext:[]};let[e,t]=o.split("	relations:"),l=t?t.split(","):[],n=[],r=0,a=e.replace(/<dbgpt-view[^>]*>[^<]*<\/dbgpt-view>/gi,e=>{try{var t;let l=e.replaceAll("\n","\\n").replace(/<[^>]*>|<\/[^>]*>/gm,""),a=JSON.parse(l),s="<custom-view>".concat(r,"</custom-view>");return n.push({...a,result:Y(null!==(t=a.result)&&void 0!==t?t:"")}),r++,s}catch(t){return console.log(t.message,t),e}});return{relations:l,cachePluginContext:n,value:a}},[o]),g=(0,x.useMemo)(()=>({"custom-view"(e){var t;let{children:l}=e,r=+l.toString();if(!p[r])return l;let{name:a,status:s,err_msg:i,result:o}=p[r],{bgClass:c,icon:d}=null!==(t=X[s])&&void 0!==t?t:{};return(0,n.jsxs)("div",{className:"bg-white dark:bg-[#212121] rounded-lg overflow-hidden my-2 flex flex-col lg:max-w-[80%]",children:[(0,n.jsxs)("div",{className:u()("flex px-4 md:px-6 py-2 items-center text-white text-sm",c),children:[a,d]}),o?(0,n.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:(0,n.jsx)($.Z,{components:z.ZP,...z.dx,children:(0,z.CE)(null!=o?o:"")})}):(0,n.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:i})]})}}),[o,p]);return m||o?(0,n.jsxs)("div",{className:u()("relative flex flex-wrap w-full p-2 md:p-4 rounded-xl break-words",{"bg-white dark:bg-[#232734]":m,"lg:w-full xl:w-full pl-0":["chat_with_db_execute","chat_dashboard"].includes(i)}),children:[(0,n.jsx)("div",{className:"mr-2 flex flex-shrink-0 items-center justify-center h-7 w-7 rounded-full text-lg sm:mr-4",children:m?(0,K.A)(c)||(0,n.jsx)(q.Z,{}):(0,n.jsx)(B.Z,{})}),(0,n.jsxs)("div",{className:"flex-1 overflow-hidden items-center text-md leading-8 pb-2",children:[!m&&"string"==typeof o&&o,m&&a&&"object"==typeof o&&(0,n.jsxs)("div",{children:["[".concat(o.template_name,"]: "),(0,n.jsxs)("span",{className:"text-theme-primary cursor-pointer",onClick:s,children:[(0,n.jsx)(W.Z,{className:"mr-1"}),o.template_introduce||"More Details"]})]}),m&&"string"==typeof o&&(0,n.jsx)($.Z,{components:{...z.ZP,...g},...z.dx,children:(0,z.CE)(Y(f))}),!!(null==h?void 0:h.length)&&(0,n.jsx)("div",{className:"flex flex-wrap mt-2",children:null==h?void 0:h.map((e,t)=>(0,n.jsx)(Q.Z,{color:"#108ee9",children:e},e+t))})]}),t]}):(0,n.jsx)("div",{className:"h-12"})}),et=l(78059),el=l(41132),en=l(74312),er=l(3414),ea=l(72868),es=l(59562),ei=l(25359),eo=l(7203),ec=l(48665),eu=l(26047),ed=l(99056),ex=l(57814),em=l(64415),eh=l(21694),ef=l(40911),ep=e=>{var t;let{conv_index:l,question:s,knowledge_space:i,select_param:o}=e,{t:c}=(0,k.$G)(),{chatId:u}=(0,x.useContext)(r.p),[d,m]=(0,x.useState)(""),[h,f]=(0,x.useState)(4),[p,g]=(0,x.useState)(""),v=(0,x.useRef)(null),[_,Z]=w.ZP.useMessage(),N=(0,x.useCallback)((e,t)=>{t?(0,a.Vx)((0,a.Eb)(u,l)).then(e=>{var t,l,n,r;let a=null!==(t=e[1])&&void 0!==t?t:{};m(null!==(l=a.ques_type)&&void 0!==l?l:""),f(parseInt(null!==(n=a.score)&&void 0!==n?n:"4")),g(null!==(r=a.messages)&&void 0!==r?r:"")}).catch(e=>{console.log(e)}):(m(""),f(4),g(""))},[u,l]),C=(0,en.Z)(er.Z)(e=>{let{theme:t}=e;return{backgroundColor:"dark"===t.palette.mode?"#FBFCFD":"#0E0E10",...t.typography["body-sm"],padding:t.spacing(1),display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4,width:"100%",height:"100%"}});return(0,n.jsxs)(ea.L,{onOpenChange:N,children:[Z,(0,n.jsx)(y.Z,{title:c("Rating"),children:(0,n.jsx)(es.Z,{slots:{root:b.ZP},slotProps:{root:{variant:"plain",color:"primary"}},sx:{borderRadius:40},children:(0,n.jsx)(et.Z,{})})}),(0,n.jsxs)(ei.Z,{children:[(0,n.jsx)(eo.Z,{disabled:!0,sx:{minHeight:0}}),(0,n.jsx)(ec.Z,{sx:{width:"100%",maxWidth:350,display:"grid",gap:3,padding:1},children:(0,n.jsx)("form",{onSubmit:e=>{e.preventDefault(),(0,a.Vx)((0,a.VC)({data:{conv_uid:u,conv_index:l,question:s,knowledge_space:i,score:h,ques_type:d,messages:p}})).then(e=>{_.open({type:"success",content:"save success"})}).catch(e=>{_.open({type:"error",content:"save error"})})},children:(0,n.jsxs)(eu.Z,{container:!0,spacing:.5,columns:13,sx:{flexGrow:1},children:[(0,n.jsx)(eu.Z,{xs:3,children:(0,n.jsx)(C,{children:c("Q_A_Category")})}),(0,n.jsx)(eu.Z,{xs:10,children:(0,n.jsx)(ed.Z,{action:v,value:d,placeholder:"Choose oneâ€¦",onChange:(e,t)=>m(null!=t?t:""),...d&&{endDecorator:(0,n.jsx)(b.ZP,{size:"sm",variant:"plain",color:"neutral",onMouseDown:e=>{e.stopPropagation()},onClick:()=>{var e;m(""),null===(e=v.current)||void 0===e||e.focusVisible()},children:(0,n.jsx)(el.Z,{})}),indicator:null},sx:{width:"100%"},children:o&&(null===(t=Object.keys(o))||void 0===t?void 0:t.map(e=>(0,n.jsx)(ex.Z,{value:e,children:o[e]},e)))})}),(0,n.jsx)(eu.Z,{xs:3,children:(0,n.jsx)(C,{children:(0,n.jsx)(y.Z,{title:(0,n.jsx)(ec.Z,{children:(0,n.jsx)("div",{children:c("feed_back_desc")})}),variant:"solid",placement:"left",children:c("Q_A_Rating")})})}),(0,n.jsx)(eu.Z,{xs:10,sx:{pl:0,ml:0},children:(0,n.jsx)(em.Z,{"aria-label":"Custom",step:1,min:0,max:5,valueLabelFormat:function(e){return({0:c("Lowest"),1:c("Missed"),2:c("Lost"),3:c("Incorrect"),4:c("Verbose"),5:c("Best")})[e]},valueLabelDisplay:"on",marks:[{value:0,label:"0"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"},{value:5,label:"5"}],sx:{width:"90%",pt:3,m:2,ml:1},onChange:e=>{var t;return f(null===(t=e.target)||void 0===t?void 0:t.value)},value:h})}),(0,n.jsx)(eu.Z,{xs:13,children:(0,n.jsx)(eh.Z,{placeholder:c("Please_input_the_text"),value:p,onChange:e=>g(e.target.value),minRows:2,maxRows:4,endDecorator:(0,n.jsx)(ef.ZP,{level:"body-xs",sx:{ml:"auto"},children:c("input_count")+p.length+c("input_unit")}),sx:{width:"100%",fontSize:14}})}),(0,n.jsx)(eu.Z,{xs:13,children:(0,n.jsx)(j.Z,{type:"submit",variant:"outlined",sx:{width:"100%",height:"100%"},children:c("submit")})})]})})})]})]})},eg=l(74434),ev=e=>{var t,l;let{messages:s,onSubmit:c,onFormatContent:m}=e,{dbParam:f,currentDialogue:Z,scene:S,model:P,refreshDialogList:E,chatId:R,agent:D,docId:F}=(0,x.useContext)(r.p),{t:M}=(0,k.$G)(),O=(0,d.useSearchParams)(),I=null!==(t=O&&O.get("select_param"))&&void 0!==t?t:"",L=null!==(l=O&&O.get("spaceNameOriginal"))&&void 0!==l?l:"",[U,$]=(0,x.useState)(!1),[z,J]=(0,x.useState)(!1),[T,G]=(0,x.useState)(s),[H,q]=(0,x.useState)(""),[B,W]=(0,x.useState)(),Q=(0,x.useRef)(null),X=(0,x.useMemo)(()=>"chat_dashboard"===S,[S]),Y=p(),et=(0,x.useMemo)(()=>{switch(S){case"chat_agent":return D;case"chat_excel":return null==Z?void 0:Z.select_param;case"chat_flow":return I;default:return L||f}},[S,D,Z,f,L,I]),el=async e=>{if(!U&&e.trim()){if("chat_agent"===S&&!D){w.ZP.warning(M("choice_agent_tip"));return}try{$(!0);let t=localStorage.getItem("dbgpt_prompt_code_".concat(R)),l={select_param:null!=et?et:""};t&&(l.prompt_code=t,localStorage.removeItem("dbgpt_prompt_code_".concat(R))),await c(e,l)}finally{$(!1)}}},en=(0,x.useCallback)(e=>X&&m&&"string"==typeof e?m(e):e,[X,m]),[er,ea]=w.ZP.useMessage(),es=async e=>{let t=X&&m&&"string"==typeof e?m(e):e,l=null==t?void 0:t.replace(/\trelations:.*/g,""),n=N()(l);n?l?er.open({type:"success",content:M("copy_success")}):er.open({type:"warning",content:M("copy_nothing")}):er.open({type:"error",content:M("copy_failed")})},ei=async()=>{!U&&F&&($(!0),await Y(F),$(!1))};(0,o.Z)(async()=>{let e=(0,i.a_)();e&&e.id===R&&(await el(e.message),E(),localStorage.removeItem(i.rU))},[R]),(0,x.useEffect)(()=>{let e=s;X&&(e=(0,C.cloneDeep)(s).map(e=>{if((null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context))try{e.context=JSON.parse(e.context)}catch(t){m&&(e.context=en(e.context))}return e})),G(e.filter(e=>["view","human"].includes(e.role)))},[X,s,m,en]),(0,x.useEffect)(()=>{(0,a.Vx)((0,a.Lu)()).then(e=>{var t;W(null!==(t=e[1])&&void 0!==t?t:{})}).catch(e=>{console.log(e)})},[]);let eo=(0,x.useRef)(!1),ec=(0,x.useRef)(0),eu=(0,x.useRef)(0),ed=(0,x.useRef)(!1),ex=(0,x.useRef)(null);(0,x.useEffect)(()=>{0===ec.current&&(ec.current=0)},[]);let em=(0,x.useCallback)(()=>{if(Q.current){let e=Q.current,{scrollTop:t,scrollHeight:l,clientHeight:n}=e,r=t+n>=l-5,a=eo.current;eo.current=!r,ed.current&&!r&&a!==eo.current&&(ed.current=!1,ex.current&&(clearTimeout(ex.current),ex.current=null))}},[]),eh=(0,x.useCallback)(()=>{if(!Q.current)return;let e=Q.current;e.scrollTo({top:e.scrollHeight,behavior:"instant"})},[]);return(0,x.useEffect)(()=>{if(!Q.current)return;let e=Q.current,t=T.length,l=t>ec.current;if(l){ex.current&&clearTimeout(ex.current),ed.current=!0,eo.current=!1,eh(),ec.current=t,eu.current=0,ex.current=setTimeout(()=>{ed.current=!1},3e3);return}if(ed.current){let t=e.scrollHeight;0===eu.current&&(eu.current=t);let l=t-eu.current;l>0&&(eh(),eu.current=t,ex.current&&clearTimeout(ex.current),ex.current=setTimeout(()=>{ed.current=!1},3e3))}else{let t=e.scrollHeight;t!==eu.current&&(eu.current=t)}},[T,S,eh]),(0,x.useEffect)(()=>{let e=Q.current;if(e)return e.addEventListener("scroll",em),()=>{e.removeEventListener("scroll",em),ex.current&&(clearTimeout(ex.current),ex.current=null)}},[em]),(0,n.jsxs)(n.Fragment,{children:[ea,(0,n.jsx)("div",{ref:Q,className:u()("flex flex-1 overflow-y-auto w-full flex-col",{"h-full":"chat_dashboard"!==S,"flex-1 min-h-0":"chat_dashboard"===S}),children:(0,n.jsx)("div",{className:"flex items-center flex-col text-sm leading-6 text-slate-900 dark:text-slate-300 sm:text-base sm:leading-7",children:T.length?T.map((e,t)=>{var l;return"chat_agent"===S?(0,n.jsx)(A,{content:e},t):(0,n.jsx)(ee,{content:e,isChartChat:X,onLinkClick:()=>{J(!0),q(JSON.stringify(null==e?void 0:e.context,null,2))},children:"view"===e.role&&(0,n.jsxs)("div",{className:"flex w-full border-t border-gray-200 dark:border-theme-dark",children:["chat_knowledge"===S&&e.retry?(0,n.jsxs)(j.Z,{onClick:ei,slots:{root:b.ZP},slotProps:{root:{variant:"plain",color:"primary"}},children:[(0,n.jsx)(g.Z,{}),"\xa0",(0,n.jsx)("span",{className:"text-sm",children:M("Retry")})]}):null,(0,n.jsxs)("div",{className:"flex w-full flex-row-reverse",children:[(0,n.jsx)(ep,{select_param:B,conv_index:Math.ceil((t+1)/2),question:null===(l=null==T?void 0:T.filter(t=>(null==t?void 0:t.role)==="human"&&(null==t?void 0:t.order)===e.order)[0])||void 0===l?void 0:l.context,knowledge_space:L||f||""}),(0,n.jsx)(y.Z,{title:M("Copy_Btn"),children:(0,n.jsx)(j.Z,{onClick:()=>es(null==e?void 0:e.context),slots:{root:b.ZP},slotProps:{root:{variant:"plain",color:"primary"}},sx:{borderRadius:40},children:(0,n.jsx)(v.Z,{})})})]})]})},t)}):(0,n.jsx)(h.Z,{description:"Start a conversation"})})}),(0,n.jsx)("div",{className:u()("relative sticky bottom-0 bg-theme-light dark:bg-theme-dark after:absolute after:-top-8 after:h-8 after:w-full after:bg-gradient-to-t after:from-theme-light after:to-transparent dark:after:from-theme-dark",{"cursor-not-allowed":"chat_excel"===S&&!(null==Z?void 0:Z.select_param)}),children:(0,n.jsxs)("div",{className:"flex flex-wrap w-full py-2 sm:pt-6 sm:pb-10 items-center",children:[P&&(0,n.jsx)("div",{className:"mr-2 flex",children:(0,K.A)(P)}),(0,n.jsx)(V,{loading:U,onSubmit:el,handleFinish:$})]})}),(0,n.jsx)(_.default,{title:"JSON Editor",open:z,width:"60%",cancelButtonProps:{hidden:!0},onOk:()=>{J(!1)},onCancel:()=>{J(!1)},children:(0,n.jsx)(eg.Z,{className:"w-full h-[500px]",language:"json",value:H})})]})},ej=l(34625);let eb=e=>{if("string"!=typeof e)return e;if(e.startsWith("```vis-thinking")||e.includes("```vis-thinking")){let t=e.indexOf('{"');if(-1!==t){let l=e.substring(t);try{return JSON.parse(l)}catch(t){let e=l.replace(/```$/g,"").trim();try{return JSON.parse(e)}catch(e){return console.error("Error parsing cleaned JSON:",e),null}}}}try{return"string"==typeof e?JSON.parse(e):e}catch(t){return console.log("Not JSON format or vis-thinking format, returning original content"),e}},ew=e=>{if("string"!=typeof e)return e;if(e.startsWith("```vis-thinking")||e.includes("```vis-thinking")){let t=e.indexOf("```vis-thinking"),l=t+15,n=e.indexOf("```",l);if(-1!==n)return e.substring(t,n+3)}return e};var ey=()=>{var e;let t=(0,d.useSearchParams)(),{scene:l,chatId:c,model:p,agent:g,setModel:v,history:j,setHistory:b}=(0,x.useContext)(r.p),{chat:w}=(0,s.Z)({}),y=null!==(e=t&&t.get("initMessage"))&&void 0!==e?e:"",[_,Z]=(0,x.useState)(!1),[N,C]=(0,x.useState)(),k=async()=>{Z(!0);let[,e]=await (0,a.Vx)((0,a.$i)(c));b(null!=e?e:[]),Z(!1)},S=e=>{var t;let l=null===(t=e[e.length-1])||void 0===t?void 0:t.context;if(l)try{let e=eb(l),t="object"==typeof e?e:"string"==typeof l?JSON.parse(l):l;C((null==t?void 0:t.template_name)==="report"?null==t?void 0:t.charts:void 0)}catch(e){console.log(e),C([])}};(0,o.Z)(async()=>{let e=(0,i.a_)();e&&e.id===c||await k()},[y,c]),(0,x.useEffect)(()=>{var e,t;if(!j.length)return;let l=null===(e=null===(t=j.filter(e=>"view"===e.role))||void 0===t?void 0:t.slice(-1))||void 0===e?void 0:e[0];(null==l?void 0:l.model_name)&&v(l.model_name),S(j)},[j.length]),(0,x.useEffect)(()=>()=>{b([])},[]);let P=(0,x.useCallback)((e,t)=>new Promise(n=>{let r=[...j,{role:"human",context:e,model_name:p,order:0,time_stamp:0},{role:"view",context:"",model_name:p,order:0,time_stamp:0}],a=r.length-1;b([...r]),w({data:{...t,chat_mode:l||"chat_normal",model_name:p,user_input:e},chatId:c,onMessage:e=>{(null==t?void 0:t.incremental)?r[a].context+=e:r[a].context=e,b([...r])},onDone:()=>{S(r),n()},onClose:()=>{S(r),n()},onError:e=>{r[a].context=e,b([...r]),n()}})}),[j,w,c,p,g,l]);return(0,n.jsxs)("div",{className:"flex flex-col h-screen w-full overflow-y-auto",children:[(0,n.jsx)(f.Z,{visible:_}),(0,n.jsx)("div",{className:"flex-none",children:(0,n.jsx)(ej.Z,{refreshHistory:k,modelChange:e=>{v(e)}})}),(0,n.jsxs)("div",{className:"flex-auto flex overflow-y-auto",children:[!!(null==N?void 0:N.length)&&(0,n.jsx)("div",{className:u()("overflow-auto",{"w-full h-1/2 md:h-full md:w-3/4 pb-4 md:pr-4":"chat_dashboard"===l}),children:(0,n.jsx)(m.ZP,{chartsData:N})}),!(null==N?void 0:N.length)&&"chat_dashboard"===l&&(0,n.jsx)("div",{className:u()("flex items-center justify-center",{"w-full h-1/2 md:h-full md:w-3/4":"chat_dashboard"===l}),children:(0,n.jsx)(h.Z,{})}),(0,n.jsx)("div",{className:u()("flex flex-col",{"w-full h-1/2 md:h-full md:w-1/4 border-t md:border-t-0 md:border-l dark:border-gray-800 overflow-y-auto":"chat_dashboard"===l,"w-full h-full px-4 lg:px-8 overflow-hidden":"chat_dashboard"!==l}),children:(0,n.jsx)("div",{className:u()("h-full",{"overflow-y-auto":"chat_dashboard"!==l,"flex flex-col":"chat_dashboard"===l}),children:(0,n.jsx)(ev,{messages:j,onSubmit:P,onFormatContent:ew})})})]})]})}},34625:function(e,t,l){"use strict";l.d(t,{Z:function(){return E}});var n=l(85893),r=l(41468),a=l(82353),s=l(16165),i=l(96991),o=l(78045),c=l(67294);function u(){let{isContract:e,setIsContract:t,scene:l}=(0,c.useContext)(r.p),u=l&&["chat_with_db_execute","chat_dashboard"].includes(l);return u?(0,n.jsxs)(o.ZP.Group,{value:e,defaultValue:!0,buttonStyle:"solid",onChange:()=>{t(!e)},children:[(0,n.jsxs)(o.ZP.Button,{value:!1,children:[(0,n.jsx)(s.Z,{component:a.ig,className:"mr-1"}),"Preview"]}),(0,n.jsxs)(o.ZP.Button,{value:!0,children:[(0,n.jsx)(i.Z,{className:"mr-1"}),"Editor"]})]}):null}l(23293);var d=l(80169),x=l(65654),m=l(34041),h=l(67421),f=function(){let{t:e}=(0,h.$G)(),{agent:t,setAgent:l}=(0,c.useContext)(r.p),{data:a=[]}=(0,x.Z)(async()=>{let[,e]=await (0,d.Vx)((0,d.H4)());return null!=e?e:[]});return(0,n.jsx)(m.default,{className:"w-60",value:t,placeholder:e("Select_Plugins"),options:a.map(e=>({label:e.app_name,value:e.app_code})),allowClear:!0,onChange:e=>{null==l||l(e)}})},p=l(29158),g=l(65775),v=l(49591),j=l(88484),b=l(45360),w=l(83062),y=l(23799),_=l(14726),Z=function(e){var t;let{convUid:l,chatMode:a,onComplete:s,...i}=e,[o,u]=(0,c.useState)(!1),[x,m]=b.ZP.useMessage(),[h,f]=(0,c.useState)([]),[Z,N]=(0,c.useState)(),{model:C}=(0,c.useContext)(r.p),{temperatureValue:k,maxNewTokensValue:S}=(0,c.useContext)(g.ChatContentContext),P=async e=>{var t;if(!e){b.ZP.error("Please select the *.(csv|xlsx|xls) file");return}if(!/\.(csv|xlsx|xls)$/.test(null!==(t=e.file.name)&&void 0!==t?t:"")){b.ZP.error("File type must be csv, xlsx or xls");return}f([e.file])},E=async()=>{u(!0);try{let e=new FormData;e.append("doc_file",h[0]),x.open({content:"Uploading ".concat(h[0].name),type:"loading",duration:0});let[t]=await (0,d.Vx)((0,d.qn)({convUid:l,chatMode:a,data:e,model:C,temperatureValue:k,maxNewTokensValue:S,config:{timeout:36e5,onUploadProgress:e=>{let t=Math.ceil(e.loaded/(e.total||0)*100);N(t)}}}));if(t)return;b.ZP.success("success"),null==s||s()}catch(e){b.ZP.error((null==e?void 0:e.message)||"Upload Error")}finally{u(!1),x.destroy()}};return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:"flex items-start gap-2",children:[m,(0,n.jsx)(w.Z,{placement:"bottom",title:"File cannot be changed after upload",children:(0,n.jsx)(y.default,{disabled:o,className:"mr-1",beforeUpload:()=>!1,fileList:h,name:"file",accept:".csv,.xlsx,.xls",multiple:!1,onChange:P,showUploadList:{showDownloadIcon:!1,showPreviewIcon:!1,showRemoveIcon:!1},itemRender:()=>(0,n.jsx)(n.Fragment,{}),...i,children:(0,n.jsx)(_.ZP,{className:"flex justify-center items-center",type:"primary",disabled:o,icon:(0,n.jsx)(v.Z,{}),children:"Select File"})})}),(0,n.jsx)(_.ZP,{type:"primary",loading:o,className:"flex justify-center items-center",disabled:!h.length,icon:(0,n.jsx)(j.Z,{}),onClick:E,children:o?100===Z?"Analysis":"Uploading":"Upload"}),!!h.length&&(0,n.jsxs)("div",{className:"mt-2 text-gray-500 text-sm flex items-center",onClick:()=>f([]),children:[(0,n.jsx)(p.Z,{className:"mr-2"}),(0,n.jsx)("span",{children:null===(t=h[0])||void 0===t?void 0:t.name})]})]})})},N=function(e){let{onComplete:t}=e,{currentDialogue:l,scene:a,chatId:s}=(0,c.useContext)(r.p);if("chat_excel"!==a)return null;let i=(null==l?void 0:l.conv_uid)===s&&(null==l?void 0:l.select_param);return(0,n.jsx)("div",{className:"max-w-md h-full relative",children:i?(0,n.jsxs)("div",{className:"flex h-8 overflow-hidden rounded",children:[(0,n.jsx)("div",{className:"flex items-center justify-center px-2 bg-gray-600 text-lg",children:(0,n.jsx)(p.Z,{className:"text-white"})}),(0,n.jsx)("div",{className:"flex items-center justify-center px-3 bg-gray-100 text-xs rounded-tr rounded-br dark:text-gray-800 truncate",children:l.select_param})]}):(0,n.jsx)(Z,{convUid:s,chatMode:a,onComplete:t})})},C=l(23430),k=l(62418),S=l(2093),P=function(){let{scene:e,dbParam:t,setDbParam:l}=(0,c.useContext)(r.p),[a,s]=(0,c.useState)([]);(0,S.Z)(async()=>{let[,t]=await (0,d.Vx)((0,d.vD)(e));s(null!=t?t:[])},[e]);let i=(0,c.useMemo)(()=>{var e;return null===(e=a.map)||void 0===e?void 0:e.call(a,e=>({name:e.param,...k.S$[e.type]}))},[a]);return((0,c.useEffect)(()=>{(null==i?void 0:i.length)&&!t&&l(i[0].name)},[i,l,t]),null==i?void 0:i.length)?(0,n.jsx)(m.default,{value:t,className:"w-36",onChange:e=>{l(e)},children:i.map(e=>(0,n.jsxs)(m.default.Option,{children:[(0,n.jsx)(C.Z,{width:24,height:24,src:e.icon,label:e.label,className:"w-[1.5em] h-[1.5em] mr-1 inline-block mt-[-4px]"}),e.name]},e.name))}):null},E=function(e){let{refreshHistory:t,modelChange:l}=e,{scene:a,refreshDialogList:s}=(0,c.useContext)(r.p);return(0,n.jsxs)("div",{className:"w-full py-2 px-4 md:px-4 flex flex-wrap items-center justify-center gap-1 md:gap-4",children:[(0,n.jsx)(P,{}),"chat_excel"===a&&(0,n.jsx)(N,{onComplete:()=>{null==s||s(),null==t||t()}}),"chat_agent"===a&&(0,n.jsx)(f,{}),(0,n.jsx)(u,{})]})}},81799:function(e,t,l){"use strict";l.d(t,{A:function(){return s}});var n=l(85893),r=l(25675),a=l.n(r);function s(e,t){let{width:l,height:r}=t||{};return e?(0,n.jsx)(a(),{className:"rounded-full border border-gray-200 object-contain bg-white inline-block",width:l||24,height:r||24,src:"/models/huggingface.svg",alt:"llm"},"/models/huggingface.svg"):null}},91085:function(e,t,l){"use strict";var n=l(85893),r=l(32983),a=l(14726),s=l(93967),i=l.n(s),o=l(67421);t.Z=function(e){let{className:t,error:l,description:s,refresh:c}=e,{t:u}=(0,o.$G)();return(0,n.jsx)(r.Z,{image:"/empty.png",imageStyle:{width:320,height:196,margin:"0 auto",maxWidth:"100%",maxHeight:"100%"},className:i()("flex items-center justify-center flex-col h-full w-full",t),description:l?(0,n.jsx)(a.ZP,{type:"primary",onClick:c,children:u("try_again")}):null!=s?s:u("no_data")})}},45247:function(e,t,l){"use strict";var n=l(85893),r=l(50888);t.Z=function(e){let{visible:t}=e;return t?(0,n.jsx)("div",{className:"absolute w-full h-full top-0 left-0 flex justify-center items-center z-10 bg-white dark:bg-black bg-opacity-50 dark:bg-opacity-50 backdrop-blur-sm text-3xl animate-fade animate-duration-200",children:(0,n.jsx)(r.Z,{})}):null}},2440:function(e,t,l){"use strict";var n=l(25519);t.Z=()=>{var e;return JSON.parse(null!==(e=localStorage.getItem(n.C9))&&void 0!==e?e:"")}},39718:function(e,t,l){"use strict";var n=l(85893),r=l(19284),a=l(25675),s=l.n(a),i=l(67294);t.Z=(0,i.memo)(e=>{let{width:t,height:l,model:a}=e,o=(0,i.useMemo)(()=>(0,r.ab)(a||"huggingface"),[a]);return a?(0,n.jsx)(s(),{className:"rounded-full border border-gray-200 object-contain bg-white inline-block",width:t||24,height:l||24,src:o,alt:"llm",priority:!0}):null})},23293:function(){}}]);